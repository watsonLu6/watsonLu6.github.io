<!DOCTYPE html>
<html lang=zh>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="renderer" content="webkit">
  <meta http-equiv="Cache-Control" content="no-transform" />
  <meta http-equiv="Cache-Control" content="no-siteapp" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="format-detection" content="telephone=no,email=no,adress=no">
  <!-- Color theme for statusbar -->
  <meta name="theme-color" content="#000000" />
  <!-- 强制页面在当前窗口以独立页面显示,防止别人在框架里调用页面 -->
  <meta http-equiv="window-target" content="_top" />
  
  
  <title>Ceph_rbd介绍与使用 | watson Lu&#39;blogs</title>
  <meta name="description" content="Ceph RBD介绍随着云计算的发展，Ceph已经成为目前最为流行的分布式存储系统，俨然存储界的Linux操作系统。Ceph集块存储、文件存储和对象存储于一身，适用场景广泛，用户众多。RBD是 Ceph 分布式存储系统中提供的块存储服务，Ceph的块存储通过一个客户端模块实现，这个客户端可以直接从数据守护进程读写数据（不需要经过一个网关）。根据客户端整合生态系统的差异，使用Ceph的块设备有两种实">
<meta property="og:type" content="article">
<meta property="og:title" content="Ceph_rbd介绍与使用">
<meta property="og:url" content="https://watsonlu6.github.io/Storage/Ceph/Ceph-rbd%E4%BB%8B%E7%BB%8D%E4%B8%8E%E4%BD%BF%E7%94%A8/index.html">
<meta property="og:site_name" content="watson&#39;blogs">
<meta property="og:description" content="Ceph RBD介绍随着云计算的发展，Ceph已经成为目前最为流行的分布式存储系统，俨然存储界的Linux操作系统。Ceph集块存储、文件存储和对象存储于一身，适用场景广泛，用户众多。RBD是 Ceph 分布式存储系统中提供的块存储服务，Ceph的块存储通过一个客户端模块实现，这个客户端可以直接从数据守护进程读写数据（不需要经过一个网关）。根据客户端整合生态系统的差异，使用Ceph的块设备有两种实">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://watsonlu6.github.io/images/rbd/rbd%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%AE%9E%E7%8E%B01.png">
<meta property="og:image" content="https://watsonlu6.github.io/images/rbd/rbd%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%AE%9E%E7%8E%B02.png">
<meta property="article:published_time" content="2021-08-10T14:26:55.000Z">
<meta property="article:modified_time" content="2024-09-08T11:25:39.559Z">
<meta property="article:author" content="John Doe">
<meta property="article:tag" content="云存储">
<meta property="article:tag" content="Ceph">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://watsonlu6.github.io/images/rbd/rbd%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%AE%9E%E7%8E%B01.png">
  <!-- Canonical links -->
  <link rel="canonical" href="https://watsonlu6.github.io/Storage/Ceph/Ceph-rbd%E4%BB%8B%E7%BB%8D%E4%B8%8E%E4%BD%BF%E7%94%A8/index.html">
  
    <link rel="alternate" href="/atom.xml" title="watson&#39;blogs" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png" type="image/x-icon">
  
  
<link rel="stylesheet" href="/css/style.css">

  
  
  
  
<meta name="generator" content="Hexo 7.3.0"></head>


<body class="main-center theme-black" itemscope itemtype="http://schema.org/WebPage">
  <header class="header" itemscope itemtype="http://schema.org/WPHeader">
  <div class="slimContent">
    <div class="navbar-header">
      
      
      <div class="profile-block text-center">
        <a id="avatar" href="https://github.com/watsonLu6/" target="_blank">
          <img class="img-circle img-rotate" src="/images/avatar.jpg" width="200" height="200">
        </a>
        <h2 id="name" class="hidden-xs hidden-sm">watson</h2>
        <h3 id="title" class="hidden-xs hidden-sm hidden-md">Cloud computing development engineer</h3>
        <small id="location" class="text-muted hidden-xs hidden-sm"><i class="icon icon-map-marker"></i> BeiJing, China</small>
      </div>
      
      <div class="search" id="search-form-wrap">

    <form class="search-form sidebar-form">
        <div class="input-group">
            <input type="text" class="search-form-input form-control" placeholder="搜索" />
            <span class="input-group-btn">
                <button type="submit" class="search-form-submit btn btn-flat" onclick="return false;"><i class="icon icon-search"></i></button>
            </span>
        </div>
    </form>
    <div class="ins-search">
  <div class="ins-search-mask"></div>
  <div class="ins-search-container">
    <div class="ins-input-wrapper">
      <input type="text" class="ins-search-input" placeholder="想要查找什么..." x-webkit-speech />
      <button type="button" class="close ins-close ins-selectable" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
    </div>
    <div class="ins-section-wrapper">
      <div class="ins-section-container"></div>
    </div>
  </div>
</div>


</div>
      <button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#main-navbar" aria-controls="main-navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
    </div>
    <nav id="main-navbar" class="collapse navbar-collapse" itemscope itemtype="http://schema.org/SiteNavigationElement" role="navigation">
      <ul class="nav navbar-nav main-nav ">
        
        
        <li class="menu-item menu-item-home">
          <a href="/.">
            
            <i class="icon icon-home-fill"></i>
            
            <span class="menu-title">首页</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-archives">
          <a href="/archives">
            
            <i class="icon icon-archives-fill"></i>
            
            <span class="menu-title">归档</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-categories">
          <a href="/categories">
            
            <i class="icon icon-folder"></i>
            
            <span class="menu-title">分类</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-tags">
          <a href="/tags">
            
            <i class="icon icon-tags"></i>
            
            <span class="menu-title">标签</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-repository">
          <a href="/repository">
            
            <i class="icon icon-project"></i>
            
            <span class="menu-title">项目</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-about">
          <a href="/about">
            
            <i class="icon icon-cup-fill"></i>
            
            <span class="menu-title">关于</span>
          </a>
        </li>
        
      </ul>
      
	
    <ul class="social-links">
    	
        <li><a href="https://github.com/watsonLu6/" target="_blank" title="Github" data-toggle=tooltip data-placement=top><i class="icon icon-github"></i></a></li>
        
        <li><a href="http://weibo.com" target="_blank" title="Weibo" data-toggle=tooltip data-placement=top><i class="icon icon-weibo"></i></a></li>
        
        <li><a href="https://twitter.com" target="_blank" title="Twitter" data-toggle=tooltip data-placement=top><i class="icon icon-twitter"></i></a></li>
        
        <li><a href="https://www.behance.net" target="_blank" title="Behance" data-toggle=tooltip data-placement=top><i class="icon icon-behance"></i></a></li>
        
        <li><a href="/atom.xml" target="_blank" title="Rss" data-toggle=tooltip data-placement=top><i class="icon icon-rss"></i></a></li>
        
    </ul>

    </nav>
  </div>
</header>

  
    <aside class="sidebar" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    
      <div class="widget">
    <h3 class="widget-title">公告</h3>
    <div class="widget-body">
        <div id="board">
            <div class="content">
                <p>欢迎交流与分享经验!</p>
            </div>
        </div>
    </div>
</div>

    
      
  <div class="widget">
    <h3 class="widget-title">分类</h3>
    <div class="widget-body">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/%E4%B8%AA%E4%BA%BA%E7%94%9F%E6%B4%BB/">个人生活</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E4%BA%91%E5%AD%98%E5%82%A8/">云存储</a><span class="category-list-count">29</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/%E4%BA%91%E5%AD%98%E5%82%A8/Ceph/">Ceph</a><span class="category-list-count">24</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E4%BA%91%E5%AD%98%E5%82%A8/%E5%AD%98%E5%82%A8%E5%9F%BA%E7%A1%80/">存储基础</a><span class="category-list-count">5</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E4%BA%91%E8%AE%A1%E7%AE%97/">云计算</a><span class="category-list-count">13</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/%E4%BA%91%E8%AE%A1%E7%AE%97/libvirt/">libvirt</a><span class="category-list-count">13</span></li></ul></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">标签</h3>
    <div class="widget-body">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Ceph/" rel="tag">Ceph</a><span class="tag-list-count">24</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/libvirt/" rel="tag">libvirt</a><span class="tag-list-count">13</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%B8%AA%E4%BA%BA%E7%94%9F%E6%B4%BB/" rel="tag">个人生活</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%BA%91%E5%AD%98%E5%82%A8/" rel="tag">云存储</a><span class="tag-list-count">29</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%BA%91%E8%AE%A1%E7%AE%97/" rel="tag">云计算</a><span class="tag-list-count">13</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%AD%98%E5%82%A8%E5%9F%BA%E7%A1%80/" rel="tag">存储基础</a><span class="tag-list-count">5</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">标签云</h3>
    <div class="widget-body tagcloud">
      <a href="/tags/Ceph/" style="font-size: 13.75px;">Ceph</a> <a href="/tags/libvirt/" style="font-size: 13.5px;">libvirt</a> <a href="/tags/%E4%B8%AA%E4%BA%BA%E7%94%9F%E6%B4%BB/" style="font-size: 13px;">个人生活</a> <a href="/tags/%E4%BA%91%E5%AD%98%E5%82%A8/" style="font-size: 14px;">云存储</a> <a href="/tags/%E4%BA%91%E8%AE%A1%E7%AE%97/" style="font-size: 13.5px;">云计算</a> <a href="/tags/%E5%AD%98%E5%82%A8%E5%9F%BA%E7%A1%80/" style="font-size: 13.25px;">存储基础</a>
    </div>
  </div>

    
      
  <div class="widget">
    <h3 class="widget-title">归档</h3>
    <div class="widget-body">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/04/">四月 2024</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/03/">三月 2024</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/10/">十月 2022</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/09/">九月 2022</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/08/">八月 2022</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/02/">二月 2022</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/11/">十一月 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/10/">十月 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/09/">九月 2021</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/08/">八月 2021</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/07/">七月 2021</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/06/">六月 2021</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/05/">五月 2021</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/04/">四月 2021</a><span class="archive-list-count">5</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget-body">
      <ul class="recent-post-list list-unstyled no-thumbnail">
        
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/%E4%BA%91%E8%AE%A1%E7%AE%97/">云计算</a><i class="icon icon-angle-right"></i><a class="category-link" href="/categories/%E4%BA%91%E8%AE%A1%E7%AE%97/libvirt/">libvirt</a>
              </p>
              <p class="item-title">
                <a href="/libvirt%E6%96%87%E6%A1%A3/13-virsh%E4%BD%BF%E7%94%A8/" class="title">13 virsh使用</a>
              </p>
              <p class="item-date">
                <time datetime="2024-04-01T07:50:26.000Z" itemprop="datePublished">2024-04-01</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/%E4%BA%91%E8%AE%A1%E7%AE%97/">云计算</a><i class="icon icon-angle-right"></i><a class="category-link" href="/categories/%E4%BA%91%E8%AE%A1%E7%AE%97/libvirt/">libvirt</a>
              </p>
              <p class="item-title">
                <a href="/libvirt%E6%96%87%E6%A1%A3/12-libvirt%E4%BD%BF%E7%94%A8%E7%A4%BA%E4%BE%8B/" class="title">12 libvirt使用示例</a>
              </p>
              <p class="item-date">
                <time datetime="2024-03-12T07:50:26.000Z" itemprop="datePublished">2024-03-12</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/%E4%BA%91%E8%AE%A1%E7%AE%97/">云计算</a><i class="icon icon-angle-right"></i><a class="category-link" href="/categories/%E4%BA%91%E8%AE%A1%E7%AE%97/libvirt/">libvirt</a>
              </p>
              <p class="item-title">
                <a href="/libvirt%E6%96%87%E6%A1%A3/11-libvirt%E8%B0%83%E8%AF%95%E4%B8%8E%E6%97%A5%E5%BF%97/" class="title">11 libvirt调试与日志</a>
              </p>
              <p class="item-date">
                <time datetime="2024-03-11T07:50:26.000Z" itemprop="datePublished">2024-03-11</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/%E4%BA%91%E8%AE%A1%E7%AE%97/">云计算</a><i class="icon icon-angle-right"></i><a class="category-link" href="/categories/%E4%BA%91%E8%AE%A1%E7%AE%97/libvirt/">libvirt</a>
              </p>
              <p class="item-title">
                <a href="/libvirt%E6%96%87%E6%A1%A3/10-libvirt%E5%AE%89%E5%85%A8%E6%A8%A1%E5%BC%8F/" class="title">10 libvirt安全模式</a>
              </p>
              <p class="item-date">
                <time datetime="2024-03-10T07:50:26.000Z" itemprop="datePublished">2024-03-10</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/%E4%BA%91%E8%AE%A1%E7%AE%97/">云计算</a><i class="icon icon-angle-right"></i><a class="category-link" href="/categories/%E4%BA%91%E8%AE%A1%E7%AE%97/libvirt/">libvirt</a>
              </p>
              <p class="item-title">
                <a href="/libvirt%E6%96%87%E6%A1%A3/9-libvirt%E4%BA%8B%E4%BB%B6%E5%92%8C%E8%AE%A1%E6%97%B6%E5%99%A8%E5%A4%84%E7%90%86/" class="title">9 libvirt事件和计时器处理</a>
              </p>
              <p class="item-date">
                <time datetime="2024-03-09T07:50:26.000Z" itemprop="datePublished">2024-03-09</time>
              </p>
            </div>
          </li>
          
      </ul>
    </div>
  </div>
  

    
  </div>
</aside>

  
  
<main class="main" role="main">
  <div class="content">
  <article id="post-Storage/Ceph/Ceph-rbd介绍与使用" class="article article-type-post" itemscope itemtype="http://schema.org/BlogPosting">
    
    <div class="article-header">
      
        
  
    <h1 class="article-title" itemprop="name">
      Ceph_rbd介绍与使用
    </h1>
  

      
      <div class="article-meta">
        <span class="article-date">
    <i class="icon icon-calendar-check"></i>
	<a href="/Storage/Ceph/Ceph-rbd%E4%BB%8B%E7%BB%8D%E4%B8%8E%E4%BD%BF%E7%94%A8/" class="article-date">
	  <time datetime="2021-08-10T14:26:55.000Z" itemprop="datePublished">2021-08-10</time>
	</a>
</span>
        
  <span class="article-category">
    <i class="icon icon-folder"></i>
    <a class="article-category-link" href="/categories/%E4%BA%91%E5%AD%98%E5%82%A8/">云存储</a>►<a class="article-category-link" href="/categories/%E4%BA%91%E5%AD%98%E5%82%A8/Ceph/">Ceph</a>
  </span>

        
  <span class="article-tag">
    <i class="icon icon-tags"></i>
	<a class="article-tag-link-link" href="/tags/Ceph/" rel="tag">Ceph</a>, <a class="article-tag-link-link" href="/tags/%E4%BA%91%E5%AD%98%E5%82%A8/" rel="tag">云存储</a>
  </span>


        

        <span class="post-comment"><i class="icon icon-comment"></i> <a href="/Storage/Ceph/Ceph-rbd%E4%BB%8B%E7%BB%8D%E4%B8%8E%E4%BD%BF%E7%94%A8/#comments" class="article-comment-link">评论</a></span>
        
      </div>
    </div>
    <div class="article-entry marked-body" itemprop="articleBody">
      
        <h2 id="Ceph-RBD介绍"><a href="#Ceph-RBD介绍" class="headerlink" title="Ceph RBD介绍"></a>Ceph RBD介绍</h2><p>随着云计算的发展，Ceph已经成为目前最为流行的分布式存储系统，俨然存储界的Linux操作系统。Ceph集块存储、文件存储和对象存储于一身，适用场景广泛，用户众多。RBD是 Ceph 分布式存储系统中提供的块存储服务，Ceph的块存储通过一个客户端模块实现，这个客户端可以直接从数据守护进程读写数据（不需要经过一个网关）。根据客户端整合生态系统的差异，使用Ceph的块设备有两种实现方式：librbd (用户态)和krbd (内核态)。RBD：RADOS Block Devices. Ceph block devices are thin-provisioned, resizable and store data striped over multiple OSDs in a Ceph cluster.<br><img src="/images/rbd/rbd%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%AE%9E%E7%8E%B01.png"></p>
<p>使用Ceph的块设备有两种路径（内核态与用户态）：(rbd map就是内核使用ceph块设备，调用librbd&#x2F;librados API访问ceph块设备是用户态)</p>
<ul>
<li>通过Kernel Module(内核态RBD)：即创建了RBD设备后，把它映射到内核中（使用rbd map命令映射到操作系统上），成为一个虚拟的块设备，这时这个块设备同其他通用块设备一样，设备文件一般为&#x2F;dev&#x2F;rbd0，后续直接使用这个块设备文件就可以了，可以把&#x2F;dev&#x2F;rbd0格式化后挂载到某目录，也可以直接作为裸设备进行使用。krbd是一个内核模块。其在内核中以一个块设备的方式加以实现。这整个Ceph客户端都是以内核模块的方式实现（没有与之相关的用户态进程或者守护进程）。krbd在内核的源码目录源文件:drivers&#x2F;block&#x2F;rbd.c、drivers&#x2F;block&#x2F;rbd_types.h、net&#x2F;ceph&#x2F;、include&#x2F;linux&#x2F;ceph<ul>
<li><a target="_blank" rel="noopener" href="https://www.likecs.com/show-203739919.html">https://www.likecs.com/show-203739919.html</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/torvalds/linux/blob/cfb92440ee71adcc2105b0890bb01ac3cddb8507/drivers/block/rbd.c">https://github.com/torvalds/linux/blob/cfb92440ee71adcc2105b0890bb01ac3cddb8507/drivers/block/rbd.c</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/torvalds/linux/tree/85c7000fda0029ec16569b1eec8fd3a8d026be73/include/linux/ceph">https://github.com/torvalds/linux/tree/85c7000fda0029ec16569b1eec8fd3a8d026be73/include/linux/ceph</a></li>
</ul>
</li>
<li>通过librbd(用户态RBD)：即创建了RBD设备后，使用librbd&#x2F;librados库访问和管理块设备。这种方式直接调用librbd提供的接口，实现对RBD设备的访问和管理，不会在客户端产生设备文件，这种方式主要是为虚拟机提供块存储设备，在虚拟机场景中，一般会用QEMU&#x2F;KVM中的RBD驱动部署Ceph块设备，宿主机通过librbd向客户端提供块存储服务。应用方案有：SPDK+librbd&#x2F;librados<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/ceph/ceph/tree/acf835db0376b1b71152949fdfec36e68f4a8474/src/librbd">https://github.com/ceph/ceph/tree/acf835db0376b1b71152949fdfec36e68f4a8474/src/librbd</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/spdk/spdk/tree/cff525d336fb2c4c087413d4c53474b9e61cbdbe/module/bdev/rbd">https://github.com/spdk/spdk/tree/cff525d336fb2c4c087413d4c53474b9e61cbdbe/module/bdev/rbd</a><br><img src="/images/rbd/rbd%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%AE%9E%E7%8E%B02.png"></li>
</ul>
</li>
</ul>
<p>RBD 的块设备由于元数据信息少而且访问不频繁，故 RBD 在 Ceph 集群中不需要单独的守护进程将元数据加载到内存进行元数据访问加速，所有的元数据和数据操作直接与集群中的 Monitor 服务和 OSD 服务进行交互。</p>
<h2 id="rbd基本块设备命令"><a href="#rbd基本块设备命令" class="headerlink" title="rbd基本块设备命令"></a>rbd基本块设备命令</h2><p><code>rbd</code>命令使你能够创建、列出、检查和删除块设备镜像。还可以使用它来克隆镜像、创建快照、将镜像回滚到快照、查看快照等。</p>
<p><strong>1. 创建块设备池</strong><br>使用 <code>ceph</code> 工具创建一个池，使用 <code>rbd</code> 工具初始化池以供 RBD 使用：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rbd pool init &lt;pool-name&gt;</span><br></pre></td></tr></table></figure>

<p><strong>2. 创建块设备用户</strong><br>除非另有说明，<code>rbd</code> 命令使用 Ceph 用户 ID <code>admin</code> 来访问 Ceph 集群。<code>admin</code> Ceph 用户 ID 允许对集群进行完全的管理访问。建议使用权限比 <code>admin</code> Ceph 用户 ID 少的 Ceph 用户 ID 访问 Ceph 集群。<br>要创建 Ceph 用户，请使用 <code>ceph auth get-or-create</code> 命令指定 Ceph 用户 ID 名称、监视器权限（capabilities）和 OSD 权限（capabilities）：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ceph auth get-or-create client.&#123;ID&#125; mon &#x27;profile rbd&#x27; osd &#x27;profile &#123;profile name&#125; [pool=&#123;pool-name&#125;][, profile ...]&#x27; mgr &#x27;profile rbd [pool=&#123;pool-name&#125;]&#x27;</span><br></pre></td></tr></table></figure>

<p>例如，要创建一个名为 <code>qemu</code> 的 Ceph 用户 ID，该用户对池 <code>vms</code> 具有读写权限，对池 <code>images</code> 具有只读权限，运行以下命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ceph auth get-or-create client.qemu mon &#x27;profile rbd&#x27; osd &#x27;profile rbd pool=vms, profile rbd-read-only pool=images&#x27; mgr &#x27;profile rbd pool=images&#x27;</span><br></pre></td></tr></table></figure>
<p><code>ceph auth get-or-create</code> 命令的输出是指定 Ceph 用户 ID 的密钥环，可以写入 <code>/etc/ceph/ceph.client.&#123;ID&#125;.keyring</code>。</p>
<p><strong>3. 创建块设备镜像</strong><br>在将块设备添加到节点之前，你必须在 Ceph 存储集群中创建一个镜像。要创建块设备镜像，请运行如下命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rbd create --size &#123;megabytes&#125; &#123;pool-name&#125;/&#123;image-name&#125;</span><br></pre></td></tr></table></figure>

<p>如果在创建镜像时未指定池，则镜像将存储在默认池 <code>rbd</code> 中。例如，如果运行以下命令，将创建一个大小为 1GB、名称为 <code>foo</code> 的镜像，并将其存储在默认池 <code>rbd</code> 中：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rbd create --size 1024 foo</span><br></pre></td></tr></table></figure>

<p><strong>4. 列出块设备镜像</strong><br>要列出 <code>rbd</code> 池中的块设备，请运行以下命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rbd <span class="built_in">ls</span></span><br></pre></td></tr></table></figure>
<p><code>rbd</code> 是默认的池名称，<code>rbd ls</code> 列出默认池中的命令。要列出特定池中的块设备，请运行以下命令，但将 <code>&#123;poolname&#125;</code> 替换为池的名称：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rbd <span class="built_in">ls</span> &#123;poolname&#125;</span><br></pre></td></tr></table></figure>

<p>要列出 <code>rbd</code> 池中的“推迟删除”块设备，请运行以下命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rbd trash <span class="built_in">ls</span> &#123;poolname&#125;</span><br></pre></td></tr></table></figure>

<p><strong>5.检索镜像信息</strong><br>要从特定镜像中检索信息，请运行以下命令，但将 <code>&#123;image-name&#125;</code> 替换为镜像的名称：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rbd info &#123;image-name&#125;</span><br></pre></td></tr></table></figure>

<p>要从池中的镜像中检索信息，请运行以下命令，但将 <code>&#123;image-name&#125;</code> 替换为镜像的名称，将 <code>&#123;pool-name&#125;</code> 替换为池的名称：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rbd info &#123;pool-name&#125;/&#123;image-name&#125;</span><br></pre></td></tr></table></figure>

<p><strong>6.调整块设备镜像大小</strong><br>Ceph 块设备镜像是按需配置的。在开始保存数据之前，它们不会实际使用任何物理存储。但是，它们确实有一个最大容量，你可以使用 <code>--size</code> 选项来设置。如果你想增加（或减少）Ceph 块设备镜像的最大大小，请运行以下命令之一：</p>
<ul>
<li><p>增加块设备镜像的大小</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rbd resize --size 2048 foo</span><br></pre></td></tr></table></figure>
</li>
<li><p>减少块设备镜像的大小</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rbd resize --size 2048 foo --allow-shrink</span><br></pre></td></tr></table></figure></li>
</ul>
<p><strong>7. 删除块设备镜像</strong><br>要删除一个块设备，请运行以下命令，但将 <code>&#123;image-name&#125;</code> 替换为你想删除的镜像的名称：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rbd <span class="built_in">rm</span> &#123;image-name&#125;</span><br></pre></td></tr></table></figure>

<p><strong>8. 从池中删除块设备</strong><br>要从池中删除块设备，请运行以下命令，但将 <code>&#123;image-name&#125;</code> 替换为要删除的镜像的名称，将 <code>&#123;pool-name&#125;</code> 替换为要从中删除镜像的池的名称：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rbd <span class="built_in">rm</span> &#123;pool-name&#125;/&#123;image-name&#125;</span><br></pre></td></tr></table></figure>

<p><strong>9. “推迟删除”块设备</strong><br>要推迟删除块设备（即将其移动到“垃圾桶”中并稍后删除），请运行以下命令，但将 <code>&#123;image-name&#125;</code> 替换为要移动到垃圾桶中的镜像的名称，将 <code>&#123;pool-name&#125;</code> 替换为池的名称：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rbd trash <span class="built_in">mv</span> &#123;pool-name&#125;/&#123;image-name&#125;</span><br></pre></td></tr></table></figure>

<p><strong>10. 从池中删除推迟的块设备</strong><br>要从池中删除推迟的块设备，请运行以下命令，但将 <code>&#123;image-id&#125;</code> 替换为要删除的镜像的 ID，将 <code>&#123;pool-name&#125;</code> 替换为要从中删除镜像的池的名称：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rbd trash <span class="built_in">rm</span> &#123;pool-name&#125;/&#123;image-id&#125;</span><br></pre></td></tr></table></figure>

<p>即使镜像有快照或被克隆使用，你也可以将其移动到垃圾桶中。但是，在这些条件下，你不能从垃圾桶中删除它。你可以使用 <code>--expires-at</code> 设置推迟时间（默认为现在）。如果推迟时间尚未到达，除非使用 <code>--force</code>，否则你不能删除镜像。</p>
<p><strong>11.恢复块设备镜像</strong><br>要恢复 <code>rbd</code> 池中的推迟删除块设备，请运行以下命令，但将 <code>&#123;image-id&#125;</code> 替换为镜像的 ID：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rbd trash restore &#123;image-id&#125;</span><br></pre></td></tr></table></figure>

<p><strong>12.恢复特定池中的块设备镜像</strong><br>要恢复特定池中的推迟删除块设备，请运行以下命令，但将 <code>&#123;image-id&#125;</code> 替换为镜像的 ID，将 <code>&#123;pool-name&#125;</code> 替换为池的名称：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rbd trash restore &#123;pool-name&#125;/&#123;image-id&#125;</span><br></pre></td></tr></table></figure>

<p><strong>13.恢复镜像时重命名</strong><br>你还可以在恢复镜像时使用 <code>--image</code> 选项进行重命名。<br>例如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rbd trash restore swimmingpool/2bf4474b0dc51 --image new-name</span><br></pre></td></tr></table></figure>


<h2 id="rbd快照"><a href="#rbd快照" class="headerlink" title="rbd快照"></a>rbd快照</h2><p>快照是某个时间点上镜像的只读逻辑副本：一个检查点。Ceph 块设备的一个高级功能是你可以创建镜像的快照，以保留时间点状态历史。Ceph 还支持快照分层，这允许你快速而轻松地克隆镜像（例如，虚拟机镜像）。Ceph 块设备快照是通过 <code>rbd</code> 命令和多个高级接口（包括 QEMU、libvirt、OpenStack、OpenNebula 和 CloudStack）进行管理的。</p>
<p>由于 RBD 对镜像（卷）内的文件系统没有感知，快照仅在发生崩溃时保持一致，除非它们在挂载（附加）操作系统内进行协调。因此，我们建议你在创建快照之前暂停或停止 I&#x2F;O 操作。</p>
<p>如果卷包含文件系统，则在创建快照之前，文件系统应该处于内部一致的状态。没有进行写操作冻结的快照在重新挂载之前可能需要进行 fsck 检查。要冻结 I&#x2F;O 操作，可以使用 <code>fsfreeze</code> 命令。有关更多详细信息，请参见 <code>fsfreeze(8)</code> 手册页。</p>
<p>对于虚拟机，可以使用 <code>qemu-guest-agent</code> 自动冻结文件系统以创建快照。</p>
<p><strong>1.创建快照</strong><br>要创建快照，请使用 <code>rbd snap create</code> 命令，并指定池名称、镜像名称和快照名称：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rbd snap create &#123;pool-name&#125;/&#123;image-name&#125;@&#123;snap-name&#125;</span><br></pre></td></tr></table></figure>

<p><strong>2.列出快照</strong><br>要列出镜像的快照，请使用 <code>rbd snap ls</code> 命令，并指定池名称和镜像名称：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rbd snap <span class="built_in">ls</span> &#123;pool-name&#125;/&#123;image-name&#125;</span><br></pre></td></tr></table></figure>

<p><strong>3.回滚快照</strong><br>要回滚到快照，请使用 <code>rbd snap rollback</code> 命令，并指定池名称、镜像名称和快照名称：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rbd snap rollback &#123;pool-name&#125;/&#123;image-name&#125;@&#123;snap-name&#125;</span><br></pre></td></tr></table></figure>
<p>将镜像回滚到快照意味着用快照中的数据覆盖镜像的当前版本。执行回滚所需的时间随着镜像大小的增加而增加。从快照克隆比回滚镜像到快照要快。克隆快照是恢复到先前状态的首选方法。</p>
<p><strong>4.删除快照</strong><br>要删除快照，请使用 <code>rbd snap rm</code> 命令，并指定池名称、镜像名称和快照名称：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rbd snap <span class="built_in">rm</span> &#123;pool-name&#125;/&#123;image-name&#125;@&#123;snap-name&#125;</span><br></pre></td></tr></table></figure>
<p>Ceph OSD 异步删除数据，因此删除快照不会立即释放底层 OSD 的容量。这个过程被称为“snaptrim”，在 <code>ceph status</code> 输出中也称为此。</p>
<p><strong>5.清除快照</strong><br>要删除所有快照，请使用 <code>rbd snap purge</code> 命令，并指定池名称和镜像名称：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rbd snap purge &#123;pool-name&#125;/&#123;image-name&#125;</span><br></pre></td></tr></table></figure>

<h2 id="rbd分层"><a href="#rbd分层" class="headerlink" title="rbd分层"></a>rbd分层</h2><p>Ceph 支持创建多个基于写时复制（COW）的块设备快照克隆。快照分层使 Ceph 块设备客户端能够非常快速地创建镜像。例如，你可以创建一个写入 Linux 虚拟机的块设备镜像，快照该镜像，保护快照，然后创建任意数量的基于写时复制的克隆。快照是只读的，因此克隆快照简化了语义，使得创建克隆变得迅速。</p>
<p>术语“父” 和 “子” 指的是 Ceph 块设备快照（父）及从快照克隆的相应镜像（子）。这些术语在下面的命令行用法中很重要。</p>
<p>每个克隆的镜像（子）存储对其父镜像的引用，这使得克隆镜像能够打开父快照并读取它。</p>
<p>基于写时复制的快照克隆表现得完全像任何其他 Ceph 块设备镜像。你可以读取、写入、克隆和调整克隆镜像的大小。克隆镜像没有特殊限制。然而，基于写时复制的快照克隆依赖于快照，因此你必须在克隆之前保护快照。下图描述了这个过程。</p>
<p>Ceph 仅支持克隆 “RBD 格式 2” 镜像（即，没有指定 <code>--image-format 1</code> 创建的镜像）。Linux 内核客户端从 3.10 版本开始支持克隆镜像。</p>
<p>Ceph 块设备分层是一个简单的过程。必须有一个镜像。必须创建镜像的快照。必须保护快照。在执行这些步骤后，你可以开始克隆快照。</p>
<p>克隆的镜像有一个对父快照的引用，并包括池 ID、镜像 ID 和快照 ID。池 ID 的包含意味着你可以将快照从一个池克隆到另一个池中的镜像。</p>
<p><strong>镜像模板</strong>：块设备分层的常见用例是创建一个基础镜像和一个作为克隆模板的快照。例如：用户可以创建一个 Linux 发行版的镜像（例如，Ubuntu 22.04）并创建其快照。用户可以定期更新镜像并创建新的快照（通过运行诸如 <code>sudo apt-get update</code>、<code>sudo apt-get upgrade</code> 或 <code>sudo apt-get dist-upgrade</code> 以及 <code>rbd snap create</code> 的命令）。随着镜像的成熟，用户可以克隆任何一个快照。</p>
<p><strong>扩展模板</strong>：更高级的用例包括扩展模板镜像以提供比基础镜像更多的信息。例如，用户可以克隆一个镜像（例如，一个虚拟机模板），安装其他软件（例如，数据库、内容管理系统、分析系统），然后对扩展的镜像进行快照，该镜像本身可以像基础镜像一样进行更新。</p>
<p><strong>模板池</strong>：使用块设备分层的一种方式是创建一个池，其中包含（1）作为模板的基础镜像和（2）这些模板的快照。然后你可以扩展只读权限给用户，以便他们可以克隆快照，即使他们没有允许在池中写入或执行的权限。</p>
<p><strong>镜像迁移&#x2F;恢复</strong>：使用块设备分层的一种方式是将数据从一个池迁移或恢复到另一个池中。</p>
<p><strong>保护快照</strong><br>克隆访问父快照。如果用户不小心删除了父快照，所有克隆都会中断。为了防止数据丢失，你必须在克隆之前保护快照：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rbd snap protect &#123;pool-name&#125;/&#123;image-name&#125;@&#123;snapshot-name&#125;</span><br></pre></td></tr></table></figure>


<p><strong>克隆快照</strong><br>要克隆快照，请指定父池、父镜像和父快照，以及子池和镜像名称。你必须在克隆之前保护快照：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rbd <span class="built_in">clone</span> &#123;pool-name&#125;/&#123;parent-image-name&#125;@&#123;snap-name&#125; &#123;pool-name&#125;/&#123;child-image-name&#125;</span><br></pre></td></tr></table></figure>
<p>可以将快照从一个池克隆到另一个池中的镜像。例如，你可以在一个池中维护只读镜像和快照作为模板，而在另一个池中维护可写的克隆。</p>
<p><strong>取消保护快照</strong><br>在删除快照之前，你必须先取消保护它。此外，你不能删除有克隆引用的快照。在取消保护快照之前，你必须先扁平化或删除每个克隆：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rbd snap unprotect &#123;pool-name&#125;/&#123;image-name&#125;@&#123;snapshot-name&#125;</span><br></pre></td></tr></table></figure>

<p><strong>列出快照的子镜像</strong><br>要列出快照的子镜像，请使用 <code>rbd children</code> 命令，并指定池名称、镜像名称和快照名称：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rbd children &#123;pool-name&#125;/&#123;image-name&#125;@&#123;snapshot-name&#125;</span><br></pre></td></tr></table></figure>

<p><strong>扁平化克隆镜像</strong><br>克隆镜像保留对父快照的引用。当你从克隆中移除对父快照的引用时，你实际上是通过将快照中存储的数据复制到克隆中来“扁平化”克隆。扁平化克隆所需的时间随着快照的大小增加。要删除快照，你必须首先扁平化子镜像（或删除它们）：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rbd flatten &#123;pool-name&#125;/&#123;image-name&#125;</span><br></pre></td></tr></table></figure>
<p>由于扁平化镜像包含快照中存储的所有数据，因此扁平化镜像比分层克隆占用更多的存储空间。</p>
<h2 id="RBD独占锁"><a href="#RBD独占锁" class="headerlink" title="RBD独占锁"></a>RBD独占锁</h2><p>独占锁是一种机制，用于防止多个进程以未协调的方式访问同一个 Rados 块设备（RBD）。独占锁在虚拟化中使用广泛（它们防止虚拟机互相覆盖写操作），以及在 RBD 镜像中（它们是基于日志的镜像中的日志记录和基于快照的镜像中增量差异快速生成的先决条件）。</p>
<p>独占锁功能在新创建的镜像上默认启用。这个默认设置可以通过 <code>rbd_default_features</code> 配置选项或 <code>rbd create</code> 命令的 <code>--image-feature</code> 和 <code>--image-shared</code> 选项进行覆盖。</p>
<p>许多镜像功能，包括对象映射和快速差异，依赖于独占锁定。禁用独占锁功能将会对某些操作的性能产生负面影响。</p>
<p>为了维护多客户端访问，独占锁功能实现了客户端之间的自动协作锁过渡。它确保在任何给定时间只有一个客户端可以写入 RBD 镜像，从而保护像对象映射、日志或 PWL 缓存这样的内部镜像结构免受并发修改。</p>
<p>独占锁对用户基本上是透明的：</p>
<ul>
<li><p>每当一个客户端（一个 librbd 进程或在 krbd 客户端的情况下，一个客户端节点的内核）需要处理对启用了独占锁的 RBD 镜像的写操作时，它首先会对该镜像获取一个独占锁。如果锁已被其他客户端持有，则会请求该客户端释放锁。</p>
</li>
<li><p>每当持有 RBD 镜像独占锁的客户端收到释放锁的请求时，它会停止处理写操作，刷新其缓存，并释放锁。</p>
</li>
<li><p>每当持有 RBD 镜像独占锁的客户端正常终止时，锁也会被正常释放。</p>
</li>
</ul>
<p>独占锁的正常释放（无论是由于请求还是客户端终止）使得另一个后续客户端能够获取锁并开始处理写操作。</p>
<p>默认情况下，独占锁功能并不防止两个或更多并发运行的客户端轮流打开同一个 RBD 镜像并写入（无论是在同一节点上还是在不同节点上）。实际上，它们的写入只是被线性化，因为锁会以协作方式自动过渡来回。</p>
<p>要禁用客户端之间的自动锁过渡，可以在获取独占锁时指定 <code>RBD_LOCK_MODE_EXCLUSIVE</code> 标志。这通过 <code>rbd device map</code> 命令的 <code>--exclusive</code> 选项暴露。</p>
<p>独占锁功能与 RBD 顾问锁（<code>rbd lock add</code> 和 <code>rbd lock rm</code> 命令）不兼容。</p>
<p><strong>阻止列表</strong></p>
<p>有时，之前持有 RBD 镜像独占锁的客户端不会正常终止，而是突然终止。这可能是因为客户端进程收到了 KILL 或 ABRT 信号，或者客户端节点经历了硬重启或遭遇了电力故障。在这种情况下，锁从未正常释放。这意味着任何新客户端在启动并尝试写入镜像时，必须打破先前持有的独占锁。</p>
<p>然而，进程（或内核线程）可能会挂起或仅仅丧失与 Ceph 集群的网络连接。在这种情况下，打破锁可能是灾难性的：挂起的进程或连接问题可能会自行解决，原始进程可能会与中间启动的新进程竞争，从而以未协调和破坏性的方式访问 RBD 数据。</p>
<p>如果锁无法以标准的正常方式获取，超越的进程不仅打破锁，还会将之前的锁持有者列入阻止列表。这是新客户端进程与 Ceph 监视器之间的协商结果。</p>
<p>在接收到阻止列表请求后，监视器会指示相关的 OSD 不再服务于旧客户端进程的请求；</p>
<p>在完成相关的 OSD 映射更新后，新客户端可以打破先前持有的锁；</p>
<p>在新客户端获取到锁后，它可以开始向镜像写入数据。</p>
<p>阻止列表因此是一种存储级别的资源隔离形式。</p>
<p>为了使阻止列表功能正常工作，客户端必须具备 <code>osd blocklist</code> 能力。这个能力包含在 <code>rbd</code> 能力配置文件中，通常应在所有使用 RBD 的 Ceph 客户端身份上设置。</p>
<h2 id="RBD-镜像同步"><a href="#RBD-镜像同步" class="headerlink" title="RBD 镜像同步"></a>RBD 镜像同步</h2><p>RBD 镜像可以在两个 Ceph 集群之间异步镜像。这一功能有两种模式：</p>
<ul>
<li><strong>基于日志的同步</strong>：该模式使用 RBD 日志镜像功能来确保集群之间的时间点、崩溃一致性复制。每次写入 RBD 镜像时，首先将写入记录到相关日志中，然后再修改实际的镜像。远程集群将从这个相关日志中读取并重放更新到其本地镜像副本。由于每次写入 RBD 镜像会导致 Ceph 集群中发生两次写入，因此在使用 RBD 日志镜像功能时，写入延迟几乎会增加一倍。</li>
<li><strong>基于快照的同步</strong>：该模式使用定期计划或手动创建的 RBD 镜像镜像快照，在集群之间复制崩溃一致的 RBD 镜像。远程集群将确定两个镜像快照之间的任何数据或元数据更新，并将差异复制到其本地镜像副本。借助 RBD 快速差异图像功能，可以快速确定更新的数据块，而无需扫描整个 RBD 镜像。由于此模式不如日志模式那样精细，因此在故障转移场景中，必须在使用之前同步两个快照之间的完整差异。任何部分应用的差异集将在故障转移时被回滚。</li>
</ul>
<p><strong>注意：</strong></p>
<ul>
<li>基于日志的同步需要 Ceph Jewel 版本或更高版本；基于快照的同步需要 Ceph Octopus 版本或更高版本。</li>
<li>镜像同步在对等集群内按池进行配置，并且可以在池内的特定图像子集上进行配置。使用基于日志的同步时，您还可以镜像池内的所有图像。镜像同步使用 <code>rbd</code> 命令配置。<code>rbd-mirror</code> 守护进程负责从远程对等集群提取镜像更新，并将其应用于本地集群中的镜像。</li>
</ul>
<p>根据复制的需求，RBD 镜像同步可以配置为单向或双向复制：</p>
<ul>
<li><strong>单向复制</strong>：当数据仅从主集群镜像到辅助集群时，<code>rbd-mirror</code> 守护进程仅在辅助集群上运行。</li>
<li><strong>双向复制</strong>：当数据从一个集群的主镜像镜像到另一个集群的非主镜像（反之亦然）时，<code>rbd-mirror</code> 守护进程会在两个集群上运行。</li>
</ul>
<p>每个 <code>rbd-mirror</code> 守护进程必须能够同时连接到本地和远程 Ceph 集群（即所有监视器和 OSD 主机）。此外，网络必须在两个数据中心之间具有足够的带宽，以处理镜像工作负载。</p>
<p><strong>1.池配置</strong><br>以下演示了如何执行基本的管理任务，以使用 <code>rbd</code> 命令配置镜像同步。镜像同步是在池级别配置的。这些池配置步骤应在两个对等集群上执行。这些过程假设名为“site-a”和“site-b”的两个集群从单个主机访问，以便清晰。</p>
<p>以下示例中的集群名称对应于具有相同名称的 Ceph 配置文件（例如 <code>/etc/ceph/site-b.conf</code>）。有关如何配置多个集群的信息，请参见 <code>ceph-conf</code> 文档。请注意，<code>rbd-mirror</code> 不要求源集群和目标集群具有唯一的内部名称；两者都可以并且应称为 ceph。<code>rbd-mirror</code> 需要的本地和远程集群的配置文件可以任意命名，容器化守护进程是一种将它们保持在 <code>/etc/ceph</code> 之外以避免混淆的策略。</p>
<p><strong>2.启用镜像同步</strong><br>要启用池的镜像同步，请使用 <code>rbd</code> 发出 <code>mirror pool enable</code> 子命令，指定池名称、镜像模式和可选的友好站点名称来描述本地集群：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rbd mirror pool enable [--site-name &#123;local-site-name&#125;] &#123;pool-name&#125; &#123;mode&#125;</span><br></pre></td></tr></table></figure>
<p>镜像模式可以是 <code>image</code> 或 <code>pool</code>：</p>
<ul>
<li><strong>image</strong>：在镜像模式下配置时，必须显式启用每个镜像的同步。</li>
<li><strong>pool（默认）</strong>：在池模式下配置时，池中所有启用了日志功能的镜像都会被镜像。</li>
</ul>
<p>创建或导入新的引导令牌时也可以指定站点名称。<br>站点名称可以使用相同的 <code>mirror pool enable</code> 子命令进行更改，但请注意，本地站点名称和远程集群使用的相应站点名称通常必须匹配。</p>
<p><strong>3.禁用镜像同步</strong><br>要禁用池上的镜像同步，请指定 <code>mirror pool disable</code> 命令和池名称：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rbd mirror pool disable &#123;pool-name&#125;</span><br></pre></td></tr></table></figure>
<p>当以这种方式禁用池上的镜像同步时，池内所有显式启用镜像同步的图像也将禁用镜像同步。<br>例如：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">rbd --cluster site-a mirror pool <span class="built_in">disable</span> image-pool</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">rbd --cluster site-b mirror pool <span class="built_in">disable</span> image-pool</span></span><br></pre></td></tr></table></figure>

<p><strong>4.引导对等集群</strong><br>为了使 <code>rbd-mirror</code> 守护进程发现其对等集群，必须注册对等集群并创建一个用户帐户。可以使用 <code>rbd</code> 和 <code>mirror pool peer bootstrap create</code> 及 <code>mirror pool peer bootstrap import</code> 命令自动完成此过程。</p>
<p>要使用 <code>rbd</code> 手动创建新的引导令牌，请发出 <code>mirror pool peer bootstrap create</code> 子命令，指定池名称和可选的友好站点名称来描述本地集群：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rbd mirror pool peer bootstrap create [--site-name &#123;local-site-name&#125;] &#123;pool-name&#125;</span><br></pre></td></tr></table></figure>

<p><code>mirror pool peer bootstrap create</code> 的输出将是一个令牌，应该提供给 <code>mirror pool peer bootstrap import</code> 命令。例如，在 site-a 上：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">rbd --cluster site-a mirror pool peer bootstrap create --site-name site-a image-pool</span></span><br><span class="line">eyJmc2lkIjoiOWY1MjgyZGItYjg5OS00NTk2LTgwOTgtMzIwYzFmYzM5NmYzIiwiY2xpZW50X2lkIjoicmJkLW1pcnJvci1wZWVyIiwia2V5IjoiQVFBUnczOWQwdkhvQmhBQVlMM1I4RmR5dHNJQU50bkFTZ0lOTVE9PSIsIm1vbl9ob3N0IjoiW3YyOjE5Mi4xNjguMS4zOjY4MjAsdjE6MTkyLjE2OC4xLjM6NjgyMV0ifQ==</span><br></pre></td></tr></table></figure>

<p>要使用 <code>rbd</code> 手动导入由另一个集群创建的引导令牌，请指定 <code>mirror pool peer bootstrap import</code> 命令，池名称、创建的令牌的文件路径（或使用 <code>-</code> 从标准输入读取），以及可选的友好站点名称来描述本地集群和镜像方向（默认为双向镜像，但也可以设置为单向镜像）：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rbd mirror pool peer bootstrap import [--site-name &#123;local-site-name&#125;] [--direction &#123;rx-only or rx-tx&#125;] &#123;pool-name&#125; &#123;token-path&#125;</span><br></pre></td></tr></table></figure>

<p>例如，在 site-b 上：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cat</span> &lt;&lt;<span class="string">EOF &gt; token</span></span></span><br><span class="line">eyJmc2lkIjoiOWY1MjgyZGItYjg5OS00NTk2LTgwOTgtMzIwYzFmYzM5NmYzIiwiY2xpZW50X2lkIjoicmJkLW1pcnJvci1wZWVyIiwia2V5IjoiQVFBUnczOWQwdkhvQmhBQVlMM1I4RmR5dHNJQU50bkFTZ0lOTVE9PSIsIm1vbl9ob3N0IjoiW3YyOjE5Mi4xNjguMS4zOjY4MjAsdjE6MTkyLjE2OC4xLjM6NjgyMV0ifQ==</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="string">rbd --cluster site-b mirror pool peer bootstrap import --site-name site-b image-pool token</span></span></span><br></pre></td></tr></table></figure>

<p><strong>5.手动添加集群对等体</strong><br>如果需要或当前安装的 Ceph 版本不支持上述引导命令，可以手动指定集群对等体。<br>远程 <code>rbd-mirror</code> 守护进程需要访问本地集群以执行镜像同步。应为远程守护进程创建一个新的本地 Ceph 用户。</p>
<p>用户可以是具有最低权限的 <code>client.radosgw</code>，例如，但最好为 <code>rbd-mirror</code> 创建一个新用户。要创建该用户，请使用以下 <code>ceph auth</code> 命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ceph auth add client.rbd-mirror mon &#x27;allow r&#x27; osd &#x27;allow rwx&#x27; mgr &#x27;allow rw&#x27; mds &#x27;allow r&#x27;</span><br></pre></td></tr></table></figure>

<p>远程集群应有一个对等集群条目以允许从远程 Ceph 集群接收镜像更新。要创建本地 Ceph 集群的对等体条目，请使用 <code>ceph</code> 命令添加对等集群的配置信息：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ceph config-key put client.radosgw.rgw_mirror.pool.&#123;pool-name&#125;.peers.&#123;remote-site-name&#125; &#123;remote-hostname&#125;:&#123;remote-port&#125; &#123;remote-client-key&#125;</span><br></pre></td></tr></table></figure>

<p>例如：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ceph config-key put client.radosgw.rgw_mirror.pool.image-pool.peers.site-b 192.168.1.1:6800 AQBzYvU5y5JYkFABx8T/8E6bErfHk8m1IoV9EA== </span><br></pre></td></tr></table></figure>

<ul>
<li><code>remote-site-name</code> 是要向其发送镜像更新的远程集群的站点名称（相当于远程集群上的站点名称）。</li>
<li><code>remote-hostname</code> 和 <code>remote-port</code> 是远程 Ceph 集群的主机名和端口。</li>
<li><code>remote-client-key</code> 是用来连接远程 Ceph 集群的密钥。</li>
</ul>
<p>一旦完成，<code>rbd-mirror</code> 守护进程将开始从对等集群同步镜像。</p>
<p><strong>6.启动镜像守护进程</strong><br>要启动 <code>rbd-mirror</code> 守护进程，请在每个 Ceph 集群的所有监视器节点上运行 <code>radosgw</code> 守护进程。通过发出 <code>systemctl</code> 命令来完成这一操作：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl start ceph-radosgw</span><br></pre></td></tr></table></figure>

<p>要检查 <code>radosgw</code> 守护进程是否正在运行，请使用以下命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl status ceph-radosgw</span><br></pre></td></tr></table></figure>
<p>完成这些步骤后，<code>rbd-mirror</code> 守护进程将在 Ceph 集群之间镜像 RBD 镜像。</p>
<h2 id="镜像实时迁移"><a href="#镜像实时迁移" class="headerlink" title="镜像实时迁移"></a>镜像实时迁移</h2><p>RBD 镜像可以在同一个 Ceph 集群内的不同池、镜像格式和&#x2F;或布局之间进行实时迁移；也可以从另一个 Ceph 集群的镜像进行迁移；或从外部数据源进行迁移。当迁移开始时，源镜像将被深度复制到目标镜像，同时保留所有快照历史，并尽可能保持数据的稀疏分配。</p>
<p>默认情况下，当在同一个 Ceph 集群内进行 RBD 镜像的实时迁移时，源镜像将被标记为只读，所有客户端将重定向 I&#x2F;O 到新的目标镜像。此外，这种模式还可以选择保留源镜像的父级链接以保留稀疏性，或者在迁移过程中将镜像扁平化，以消除对源镜像父级的依赖。</p>
<p>实时迁移过程还可以在仅导入模式下使用，其中源镜像保持不变，目标镜像可以链接到另一个 Ceph 集群中的镜像或外部数据源，如备份文件、HTTP(s) 文件、S3 对象或 NBD 导出。</p>
<p>实时迁移复制过程可以在新的目标镜像被使用时安全地在后台运行。在不使用仅导入模式的情况下，目前要求在准备迁移之前暂时停止使用源镜像。这有助于确保使用镜像的客户端被更新为指向新的目标镜像。</p>
<p>实时迁移需要 Ceph Nautilus 版本或更高版本。对外部数据源的支持需要 Ceph Pacific 版本或更高版本。krbd 内核模块目前不支持实时迁移。</p>
<p><strong>实时迁移过程包含三个步骤：</strong></p>
<ul>
<li><p><strong>准备迁移</strong>：初始步骤创建新的目标镜像并将其链接到源镜像。如果没有配置为仅导入模式，源镜像也会被链接到目标镜像，并标记为只读。类似于分层镜像，尝试读取目标镜像内的未初始化数据区段将内部重定向读取到源镜像，写入未初始化区段将内部深度复制重叠的源镜像块到目标镜像。</p>
</li>
<li><p><strong>执行迁移</strong>：这是一个后台操作，将源镜像中的所有初始化块深度复制到目标镜像。这一步可以在客户端正在积极使用新目标镜像时运行。</p>
</li>
<li><p><strong>完成迁移</strong>：一旦后台迁移过程完成，可以提交或中止迁移。提交迁移将移除源镜像和目标镜像之间的交叉链接，并在未配置为仅导入模式时移除源镜像。中止迁移将移除交叉链接，并移除目标镜像。</p>
</li>
</ul>
<p><strong>1.准备迁移</strong><br>在同一个 Ceph 集群内的镜像进行实时迁移的默认过程是通过运行 <code>rbd migration prepare</code> 命令来启动，提供源镜像和目标镜像：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">rbd migration prepare migration_source [migration_target]</span></span><br></pre></td></tr></table></figure>

<p><code>rbd migration prepare</code> 命令接受与 <code>rbd create</code> 命令相同的布局选项，这允许更改不可变的镜像磁盘布局。如果目标镜像是仅用于更改磁盘布局而保持原始镜像名称，则可以跳过 <code>migration_target</code>。</p>
<p>在准备实时迁移之前，必须停止所有使用源镜像的客户端。如果在准备步骤中发现任何客户端以读写模式打开镜像，则准备步骤将失败。一旦准备步骤完成，客户端可以使用新的目标镜像名称重新启动。尝试使用源镜像名称重新启动客户端将导致失败。</p>
<p><code>rbd status</code> 命令将显示实时迁移的当前状态：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">rbd status migration_target</span></span><br><span class="line">Watchers: none</span><br><span class="line">Migration:</span><br><span class="line">            source: rbd/migration_source (5e2cba2f62e)</span><br><span class="line">            destination: rbd/migration_target (5e2ed95ed806)</span><br><span class="line">            state: prepared</span><br></pre></td></tr></table></figure>

<p>请注意，为避免在迁移过程中误用，源镜像将被移动到 RBD 垃圾箱中：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">rbd info migration_source</span></span><br><span class="line">rbd: error opening image migration_source: (2) No such file or directory</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">rbd trash <span class="built_in">ls</span> --all</span></span><br><span class="line">5e2cba2f62e migration_source</span><br></pre></td></tr></table></figure>

<p><strong>2.准备仅导入迁移</strong><br>仅导入的实时迁移过程是通过运行相同的 <code>rbd migration prepare</code> 命令来启动，但添加 <code>--import-only</code> 可选项，并提供 JSON 编码的源规格来描述如何访问源镜像数据。这个源规格可以通过 <code>--source-spec</code> 可选项直接传递，或通过 <code>--source-spec-path</code> 可选项通过文件或标准输入传递：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">rbd migration prepare --import-only --source-spec <span class="string">&quot;&lt;JSON&gt;&quot;</span> migration_target</span></span><br></pre></td></tr></table></figure>

<p><code>rbd migration prepare</code> 命令接受与 <code>rbd create</code> 命令相同的布局选项。</p>
<p><code>rbd status</code> 命令将显示实时迁移的当前状态：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">rbd status migration_target</span></span><br><span class="line">Watchers: none</span><br><span class="line">Migration:</span><br><span class="line">        source: &#123;&quot;stream&quot;:&#123;&quot;file_path&quot;:&quot;/mnt/image.raw&quot;,&quot;type&quot;:&quot;file&quot;&#125;,&quot;type&quot;:&quot;raw&quot;&#125;</span><br><span class="line">        destination: rbd/migration_target (ac69113dc1d7)</span><br><span class="line">        state: prepared</span><br></pre></td></tr></table></figure>

<p>源规格 JSON 的一般格式如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&lt;format-type&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">    &lt;format unique parameters&gt;</span><br><span class="line">    <span class="attr">&quot;stream&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&lt;stream-type&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">        &lt;stream unique parameters&gt;</span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>当前支持的格式包括：native、qcow 和 raw。当前支持的流类型包括：file、http、s3 和 nbd。</p>
<p><strong>格式</strong></p>
<ul>
<li><strong>native 格式</strong> 可以用来描述 Ceph 集群内的本地 RBD 镜像作为源镜像。其源规格 JSON 编码如下：</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;native&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">[</span><span class="attr">&quot;cluster_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&lt;cluster-name&gt;&quot;</span><span class="punctuation">,</span><span class="punctuation">]</span> (如果镜像在其他集群中，指定，要求 `&lt;cluster-name&gt;.conf` 文件)</span><br><span class="line">    <span class="punctuation">[</span><span class="attr">&quot;client_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&lt;client-name&gt;&quot;</span><span class="punctuation">,</span><span class="punctuation">]</span> (用于连接到其他集群，默认为 `client.admin`)</span><br><span class="line">    <span class="attr">&quot;pool_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&lt;pool-name&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">[</span><span class="attr">&quot;pool_id&quot;</span><span class="punctuation">:</span> &lt;pool-id&gt;<span class="punctuation">,</span><span class="punctuation">]</span> (可选，作为 <span class="string">&quot;pool_name&quot;</span> 的替代)</span><br><span class="line">    <span class="punctuation">[</span><span class="attr">&quot;pool_namespace&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&lt;pool-namespace&quot;</span><span class="punctuation">,</span><span class="punctuation">]</span> (可选)</span><br><span class="line">    <span class="attr">&quot;image_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&lt;image-name&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">[</span><span class="attr">&quot;image_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&lt;image-id&gt;&quot;</span><span class="punctuation">,</span><span class="punctuation">]</span> (如果镜像在垃圾箱中，指定)</span><br><span class="line">    <span class="attr">&quot;snap_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&lt;snap-name&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">[</span><span class="attr">&quot;snap_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&lt;snap-id&gt;&quot;</span><span class="punctuation">,</span><span class="punctuation">]</span> (可选，作为 <span class="string">&quot;snap_name&quot;</span> 的替代)</span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>注意，native 格式不包括 stream 对象，因为它利用了 Ceph 的本地操作。例如，要从镜像 <code>rbd/ns1/image1@snap1</code> 导入，源规格可以编码为：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;native&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;pool_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;rbd&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;pool_namespace&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ns1&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;image_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;image1&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;snap_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;snap1&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p><strong>qcow 格式</strong> 可用于描述 QCOW（QEMU copy-on-write）块设备。目前支持 QCOW（v1）和 QCOW2 格式，但不支持高级功能，如压缩、加密、备份文件和外部数据文件。未来版本可能会添加对这些缺失功能的支持。qcow 格式数据可以链接到任何支持的流源。例如，其基本源规格 JSON 编码如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;qcow&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;stream&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        &lt;stream unique parameters&gt;</span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>raw 格式</strong> 可用于描述厚配置的原始块设备导出（即 <code>rbd export --export-format 1 &lt;snap-spec&gt;</code>）。raw 格式数据可以链接到任何支持的流源。例如，其基本源规格 JSON 编码如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;raw&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;stream&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        &lt;stream unique parameters for HEAD<span class="punctuation">,</span> non-snapshot revision&gt;</span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;snapshots&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;raw&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&lt;snapshot-name&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;stream&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                &lt;stream unique parameters for snapshot&gt;</span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">]</span> (可选，按从旧到新的顺序排列的快照)</span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>快照数组的包含是可选的，目前仅支持厚配置的原始快照导出。未来版本将添加更多格式，如 RBD export-format v2 和 RBD export-diff 快照。</p>
</li>
<li><p><strong>file 流</strong> 可用于从本地可访问的 POSIX 文件源导入。其源规格 JSON 编码如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    &lt;format unique parameters&gt;</span><br><span class="line">    <span class="attr">&quot;stream&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;file&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;file_path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&lt;file-path&gt;&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>例如，要从位于 <code>/mnt/image.raw</code> 的文件导入 raw 格式镜像，其源规格 JSON 编码如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;raw&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;stream&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;file&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;file_path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/mnt/image.raw&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>http 流</strong> 可用于从远程 HTTP 或 HTTPS 网络服务器导入。其源规格 JSON 编码如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    &lt;format unique parameters&gt;</span><br><span class="line">    <span class="string">&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">stream&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;url&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&lt;url-path&gt;&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>例如，要从位于 <code>http://download.ceph.com/image.raw</code> 的文件导入 raw 格式镜像，其源规格 JSON 编码如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;raw&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;stream&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;url&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http://download.ceph.com/image.raw&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>s3 流</strong> 可用于从远程 S3 存储桶导入。其源规格 JSON 编码如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    &lt;format unique parameters&gt;</span><br><span class="line">    <span class="attr">&quot;stream&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;s3&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;url&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&lt;url-path&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;access_key&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&lt;access-key&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;secret_key&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&lt;secret-key&gt;&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>例如，要从位于 <code>http://s3.ceph.com/bucket/image.raw</code> 的文件导入 raw 格式镜像，其源规格 JSON 编码如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;raw&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;stream&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;s3&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;url&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http://s3.ceph.com/bucket/image.raw&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;access_key&quot;</span><span class="punctuation">:</span> <span class="string">&quot;NX5QOQKC6BH2IDN8HC7A&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;secret_key&quot;</span><span class="punctuation">:</span> <span class="string">&quot;LnEsqNNqZIpkzauboDcLXLcYaWwLQ3Kop0zAnKIn&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></li>
</ul>
<p><code>access_key</code> 和 <code>secret_key</code> 参数支持将密钥存储在 MON 配置密钥存储中，可以通过在密钥值前加上 <code>config://</code> 前缀和路径来实现。可以通过 <code>ceph config-key set &lt;key-path&gt; &lt;value&gt;</code> 来存储值（例如 <code>ceph config-key set rbd/s3/access_key NX5QOQKC6BH2IDN8HC7A</code>）。</p>
<p><strong>nbd 流</strong> 可用于从远程 NBD 导出导入。其源规格 JSON 编码如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    &lt;format unique parameters&gt;</span><br><span class="line">    <span class="attr">&quot;stream&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;nbd&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;uri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&lt;nbd-uri&gt;&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>例如，要从位于 <code>nbd://nbd.ceph.com</code> 的 NBD 导出中导入 raw 格式镜像，导出名称为 <code>image.raw</code>，其源规格 JSON 编码如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;raw&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;stream&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;nbd&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;uri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;nbd://nbd.ceph.com/image.raw&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><code>nbd-uri</code> 参数应遵循 NBD URI 规范。默认 NBD 端口是 10809。</p>
<p><strong>3.执行迁移</strong><br>准备好实时迁移后，必须将源镜像的块复制到目标镜像。这是通过运行 <code>rbd migration execute</code> 命令来完成的：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">rbd migration execute migration_target</span></span><br><span class="line">Image migration: 100% complete...done.</span><br></pre></td></tr></table></figure>

<p><code>rbd status</code> 命令还会提供迁移块深度复制过程的进度反馈：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">rbd status migration_target</span></span><br><span class="line">Watchers:</span><br><span class="line">    watcher=1.2.3.4:0/3695551461 client.123 cookie=123</span><br><span class="line">Migration:</span><br><span class="line">            source: rbd/migration_source (5e2cba2f62e)</span><br><span class="line">            destination: rbd/migration_target (5e2ed95ed806)</span><br><span class="line">            state: executing (32% complete)</span><br></pre></td></tr></table></figure>

<p><strong>4.提交迁移</strong><br>一旦实时迁移完成了从源镜像到目标镜像的所有数据块的深度复制，可以提交迁移：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">rbd status migration_target</span></span><br><span class="line">Watchers: none</span><br><span class="line">Migration:</span><br><span class="line">            source: rbd/migration_source (5e2cba2f62e)</span><br><span class="line">            destination: rbd/migration_target (5e2ed95ed806)</span><br><span class="line">            state: executed</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">rbd migration commit migration_target</span></span><br><span class="line">Commit image migration: 100% complete...done.</span><br></pre></td></tr></table></figure>

<p>如果 <code>migration_source</code> 镜像是一个或多个克隆的父镜像，则需要在确保所有后代克隆镜像未使用的情况下指定 <code>--force</code> 选项。</p>
<p>提交实时迁移将移除源镜像和目标镜像之间的交叉链接，并移除源镜像：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">rbd trash list --all</span></span><br></pre></td></tr></table></figure>

<p><strong>5.中止迁移</strong><br>如果希望撤销准备或执行步骤，可以运行 <code>rbd migration abort</code> 命令以撤销迁移过程：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">rbd migration abort migration_target</span></span><br><span class="line">Abort image migration: 100% complete...done.</span><br></pre></td></tr></table></figure>
<p>中止迁移将导致目标镜像被删除，并恢复对原始源镜像的访问：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">rbd <span class="built_in">ls</span></span></span><br><span class="line">migration_source</span><br></pre></td></tr></table></figure>

<h2 id="RBD-持久只读缓存"><a href="#RBD-持久只读缓存" class="headerlink" title="RBD 持久只读缓存"></a>RBD 持久只读缓存</h2><h4 id="共享只读父镜像缓存"><a href="#共享只读父镜像缓存" class="headerlink" title="共享只读父镜像缓存"></a>共享只读父镜像缓存</h4><p>克隆的 RBD 镜像通常只修改父镜像的一小部分。例如，在 VDI 使用场景中，虚拟机是从相同的基础镜像克隆的，最初的区别仅在于主机名和 IP 地址。在启动过程中，所有这些虚拟机读取的是相同父镜像数据的不同部分。如果我们有一个本地的父镜像缓存，这将加速缓存主机上的读取操作，同时减少客户端到集群的网络流量。RBD 缓存必须在 ceph.conf 中显式启用。ceph-immutable-object-cache 守护进程负责在本地磁盘上缓存父内容，未来对该数据的读取将从本地缓存中提供。<br>RBD 共享只读父镜像缓存需要 Ceph Nautilus 版本或更高版本。</p>
<p><strong>启用 RBD 共享只读父镜像缓存</strong><br>要启用 RBD 共享只读父镜像缓存，需要在 ceph.conf 文件的 [client] 部分中添加以下 Ceph 设置：</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rbd parent cache <span class="attr">enabled</span> = <span class="literal">true</span></span><br><span class="line">rbd <span class="attr">plugins</span> = parent_cache</span><br></pre></td></tr></table></figure>

<h4 id="不可变对象缓存守护进程"><a href="#不可变对象缓存守护进程" class="headerlink" title="不可变对象缓存守护进程"></a>不可变对象缓存守护进程</h4><p>ceph-immutable-object-cache 守护进程负责在其本地缓存目录中缓存父镜像内容。建议使用 SSD 作为底层存储，因为这样可以提供更好的性能。<br>守护进程的主要组件包括：</p>
<ul>
<li>基于域套接字的进程间通信（IPC）：守护进程在启动时监听本地域套接字，并等待来自 librbd 客户端的连接。</li>
<li>基于 LRU 的提升&#x2F;降级策略：守护进程维护每个缓存文件的内存中缓存命中统计。如果容量达到配置的阈值，则降级冷缓存。</li>
<li>基于文件的缓存存储：守护进程维护一个简单的文件缓存存储。在提升时，RADOS 对象从 RADOS 集群中获取并存储在本地缓存目录中。</li>
</ul>
<p>当每个克隆的 RBD 镜像被打开时，librbd 尝试通过其 Unix 域套接字连接到缓存守护进程。在 librbd 成功连接后，它在每次后续读取时与守护进程协调。在未缓存读取的情况下，守护进程将 RADOS 对象提升到本地缓存目录中，下一个读取操作将从缓存中服务。守护进程维护简单的 LRU 统计信息，用于在需要时逐出冷缓存文件（例如，当缓存达到容量并且受到压力时）。</p>
<p>以下是一些重要的缓存配置设置：</p>
<ul>
<li><p><strong>immutable_object_cache_sock</strong><br>描述：用于 librbd 客户端和 ceph-immutable-object-cache 守护进程之间通信的域套接字路径。<br>类型：字符串<br>必需：否<br>默认值：<code>/var/run/ceph/immutable_object_cache_sock</code></p>
</li>
<li><p><strong>immutable_object_cache_path</strong><br>描述：不可变对象缓存数据目录。<br>类型：字符串<br>必需：否<br>默认值：<code>/tmp/ceph_immutable_object_cache</code></p>
</li>
<li><p><strong>immutable_object_cache_max_size</strong><br>描述：不可变缓存的最大大小。<br>类型：大小<br>必需：否<br>默认值：<code>1G</code></p>
</li>
<li><p><strong>immutable_object_cache_watermark</strong><br>描述：缓存的高水位线。值在 (0, 1) 之间。如果缓存大小达到此阈值，守护进程将开始根据 LRU 统计信息删除冷缓存。<br>类型：浮点数<br>必需：否<br>默认值：<code>0.9</code></p>
</li>
</ul>
<p>ceph-immutable-object-cache 守护进程可以在可选的 ceph-immutable-object-cache 发行包中找到。<br>ceph-immutable-object-cache 守护进程需要能够连接到 RADOS 集群。</p>
<p><strong>运行不可变对象缓存守护进程</strong><br>ceph-immutable-object-cache 守护进程应使用唯一的 Ceph 用户 ID。要创建 Ceph 用户，可以使用 ceph 指定 <code>auth get-or-create</code> 命令、用户名、监视器权限和 OSD 权限：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ceph auth get-or-create client.ceph-immutable-object-cache.&#123;unique id&#125; mon &#x27;allow r&#x27; osd &#x27;profile rbd-read-only&#x27;</span><br></pre></td></tr></table></figure>

<p>ceph-immutable-object-cache 守护进程可以通过 systemd 管理，将用户 ID 作为守护进程实例指定：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable ceph-immutable-object-cache@ceph-immutable-object-cache.&#123;unique id&#125;</span><br></pre></td></tr></table></figure>

<p>ceph-immutable-object-cache 也可以通过 ceph-immutable-object-cache 命令在前台运行：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ceph-immutable-object-cache -f --log-file=&#123;log_path&#125;</span><br></pre></td></tr></table></figure>

<p><strong>QOS 设置</strong><br>不可变对象缓存支持限流，由以下设置控制：</p>
<ul>
<li><p><strong>immutable_object_cache_qos_schedule_tick_min</strong><br>描述：不可变对象缓存的最小调度间隔。<br>类型：毫秒<br>必需：否<br>默认值：<code>50</code></p>
</li>
<li><p><strong>immutable_object_cache_qos_iops_limit</strong><br>描述：每秒所需的不可变对象缓存 IO 操作限制。<br>类型：无符号整数<br>必需：否<br>默认值：<code>0</code></p>
</li>
<li><p><strong>immutable_object_cache_qos_iops_burst</strong><br>描述：不可变对象缓存 IO 操作的突发限制。<br>类型：无符号整数<br>必需：否<br>默认值：<code>0</code></p>
</li>
<li><p><strong>immutable_object_cache_qos_iops_burst_seconds</strong><br>描述：不可变对象缓存 IO 操作的突发持续时间（秒）。<br>类型：秒<br>必需：否<br>默认值：<code>1</code></p>
</li>
<li><p><strong>immutable_object_cache_qos_bps_limit</strong><br>描述：每秒所需的不可变对象缓存 IO 字节限制。<br>类型：无符号整数<br>必需：否<br>默认值：<code>0</code></p>
</li>
<li><p><strong>immutable_object_cache_qos_bps_burst</strong><br>描述：不可变对象缓存 IO 字节的突发限制。<br>类型：无符号整数<br>必需：否<br>默认值：<code>0</code></p>
</li>
<li><p><strong>immutable_object_cache_qos_bps_burst_seconds</strong><br>描述：不可变对象缓存 IO 字节的突发持续时间（秒）。<br>类型：秒<br>必需：否<br>默认值：<code>1</code></p>
</li>
</ul>
<h2 id="RBD-持久写日志缓存"><a href="#RBD-持久写日志缓存" class="headerlink" title="RBD 持久写日志缓存"></a>RBD 持久写日志缓存</h2><p>持久写日志缓存（PWL）为基于 librbd 的 RBD 客户端提供了一个持久且容错的写回缓存。</p>
<p>该缓存采用日志顺序写回设计，内部维护检查点，以确保写入被刷新回集群时始终保持崩溃一致性。即使客户端缓存完全丢失，磁盘镜像仍然是一致的，但数据可能会显得过时。</p>
<p>此缓存可以使用 PMEM 或 SSD 作为缓存设备。对于 PMEM，缓存模式称为副本写日志（rwl）。目前仅支持本地缓存，副本功能尚在开发中。对于 SSD，缓存模式称为 ssd。</p>
<p><strong>使用</strong><br>PWL 缓存在持久设备中管理缓存数据。它会在配置的目录中查找并创建缓存文件，然后将数据缓存到文件中。<br>PWL 缓存依赖于独占锁功能。只有在获取了独占锁后，缓存才能加载。</p>
<p>缓存提供两种不同的持久性模式。在持久写模式下，写入操作仅在写入被持久化到缓存设备后才会完成，并且在崩溃后仍然可读。在持久刷新模式下，写入操作一旦不再需要调用者的数据缓冲区即可完成，但不保证在崩溃后写入数据可读。数据在收到刷新请求时持久化到缓存设备。<br>默认情况下，缓存模式为持久写模式，在第一次刷新请求后切换到持久刷新模式。</p>
<p><strong>1.启用缓存</strong><br>要启用 PWL 缓存，请设置以下配置项：</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">rbd_persistent_cache_mode</span> = &#123;cache-mode&#125;</span><br><span class="line"><span class="attr">rbd_plugins</span> = pwl_cache</span><br></pre></td></tr></table></figure>

<p><code>&#123;cache-mode&#125;</code> 的值可以是 rwl、ssd 或 disabled。默认情况下，缓存是禁用的。</p>
<p>rwl 缓存模式依赖于 libpmem 库（PMDK 的一部分）。它在 x86_64 架构上应普遍可用，并且在某些发行版的 ppc64le 和 aarch64 架构上也可能可用。在 s390x 架构上不可用。</p>
<p>以下是一些缓存配置项：</p>
<ul>
<li><p><strong>rbd_persistent_cache_path</strong><br>描述：缓存数据的文件夹。在使用 rwl 模式时，这个文件夹必须启用 DAX（参见 DAX），以避免性能下降。<br>类型：字符串<br>必需：否<br>默认值：无</p>
</li>
<li><p><strong>rbd_persistent_cache_size</strong><br>描述：每个镜像的缓存大小。最小缓存大小为 1 GB。<br>类型：大小<br>必需：否<br>默认值：无</p>
</li>
</ul>
<p>上述配置可以按主机、池、镜像等进行设置。例如，要按主机设置，请将覆盖项添加到主机的 ceph.conf 文件的相应部分。要按池、镜像等设置，请参阅 rbd 配置命令。</p>
<p><strong>2.缓存状态</strong><br>当获取到独占锁时，PWL 缓存被启用；当释放独占锁时，缓存被关闭。要检查缓存状态，可以使用命令 <code>rbd status</code>。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rbd status &#123;pool-name&#125;/&#123;image-name&#125;</span><br></pre></td></tr></table></figure>

<p>状态信息将显示，包括当前状态、清理状态、缓存大小、位置以及一些基本指标。<br>例如：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">rbd status rbd/foo</span></span><br><span class="line">Watchers:</span><br><span class="line">        watcher=10.10.0.102:0/1061883624 client.25496 cookie=140338056493088</span><br><span class="line">Persistent cache state:</span><br><span class="line">        host: sceph9</span><br><span class="line">        path: /mnt/nvme0/rbd-pwl.rbd.101e5824ad9a.pool</span><br><span class="line">        size: 1 GiB</span><br><span class="line">        mode: ssd</span><br><span class="line">        stats_timestamp: Sun Apr 10 13:26:32 2022</span><br><span class="line">        present: true   empty: false    clean: false</span><br><span class="line">        allocated: 509 MiB</span><br><span class="line">        cached: 501 MiB</span><br><span class="line">        dirty: 338 MiB</span><br><span class="line">        free: 515 MiB</span><br><span class="line">        hits_full: 1450 / 61%</span><br><span class="line">        hits_partial: 0 / 0%</span><br><span class="line">        misses: 924</span><br><span class="line">        hit_bytes: 192 MiB / 66%</span><br><span class="line">        miss_bytes: 97 MiB</span><br></pre></td></tr></table></figure>

<p><strong>3.刷新缓存</strong><br>要刷新 RBD 缓存文件，请指定持久缓存刷新命令、池名称和镜像名称：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rbd persistent-cache flush &#123;pool-name&#125;/&#123;image-name&#125;</span><br></pre></td></tr></table></figure>
<p>如果应用程序意外崩溃，此命令也可以用于将缓存刷新回 OSDs。<br>例如：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">rbd persistent-cache flush rbd/foo</span></span><br></pre></td></tr></table></figure>

<p><strong>4.使缓存失效</strong><br>要使 RBD 缓存文件失效（丢弃），请指定持久缓存失效命令、池名称和镜像名称：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rbd persistent-cache invalidate &#123;pool-name&#125;/&#123;image-name&#125;</span><br></pre></td></tr></table></figure>

<p>该命令会移除对应镜像的缓存元数据，禁用缓存功能，并删除本地缓存文件（如果存在）。<br>例如：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">rbd persistent-cache invalidate rbd/foo</span></span><br></pre></td></tr></table></figure>


<h2 id="镜像加密"><a href="#镜像加密" class="headerlink" title="镜像加密"></a>镜像加密</h2><p>从 Pacific 版本开始，镜像级别的加密可以由 RBD 客户端内部处理。这意味着你可以设置一个秘密密钥，用于加密特定的 RBD 镜像。此页面描述了 RBD 加密功能的范围。</p>
<p>当前 krbd 内核模块不支持加密。也可以使用外部工具（如 dm-crypt、QEMU）来加密 RBD 镜像，这些工具的功能集和限制可能与这里描述的有所不同。</p>
<h4 id="加密格式"><a href="#加密格式" class="headerlink" title="加密格式"></a>加密格式</h4><p>默认情况下，RBD 镜像是未加密的。要加密 RBD 镜像，必须将其格式化为支持的加密格式之一。格式化操作会将加密元数据持久化到镜像中。加密元数据通常包括加密格式和版本、加密算法和模式规范，以及用于保护加密密钥的信息。加密密钥本身由用户保管的秘密（通常是密码短语）保护，该秘密不会持久化。基本的加密格式操作需要指定加密格式和一个秘密。</p>
<p>一些加密元数据可能作为镜像数据的一部分存储，通常一个加密头会写入原始镜像数据的开头。这意味着加密镜像的有效镜像大小可能低于原始镜像大小。有关更多详细信息，请参见支持的格式部分。</p>
<p>除非明确（重新）格式化，否则加密镜像的克隆会使用相同的格式和秘密进行加密。</p>
<p>加密镜像的克隆始终会被加密。重新格式化为明文是不支持的。</p>
<p>格式化前写入镜像的数据可能变得不可读，尽管它仍然可能占用存储资源。</p>
<p>启用了日志功能的镜像不能由 RBD 客户端格式化和加密。</p>
<h4 id="加密加载"><a href="#加密加载" class="headerlink" title="加密加载"></a>加密加载</h4><p>格式化镜像是启用加密的必要前提。然而，格式化的镜像仍将被所有 RBD API 视为原始未加密镜像。特别是，加密的 RBD 镜像可以通过与其他镜像相同的 API 打开，并可以读取&#x2F;写入原始未加密数据。这种原始 IO 可能会影响加密格式的完整性，例如覆盖位于镜像开头的加密元数据。</p>
<p>为了安全地对格式化的镜像执行加密 IO，应在打开镜像后应用额外的加密加载操作。加密加载操作需要提供加密格式和一个秘密，以解锁镜像及其所有显式格式化祖先镜像的加密密钥。成功的加密加载操作后，所有对已打开镜像的 IO 将被加密&#x2F;解密。对于克隆镜像，这也包括祖先镜像的 IO。加密密钥将由 RBD 客户端保存在内存中，直到镜像被关闭。</p>
<p>一旦加载了加密，不能对已打开镜像的上下文应用其他加密加载&#x2F;格式化操作。<br>一旦加载了加密，使用打开的镜像上下文的 API 调用将返回有效镜像大小和有效父重叠。<br>一旦加载了加密，调整镜像大小的 API 调用将把指定的目标大小解释为有效镜像大小。</p>
<p>如果加密镜像的克隆被显式格式化，则克隆镜像的扁平化操作不再透明，因为父数据必须根据克隆镜像的格式重新加密，因为它是从父快照中复制的。如果在执行扁平化操作之前没有加载加密，则克隆镜像中之前可访问的任何父数据可能变得不可读。</p>
<p>如果加密镜像的克隆被显式格式化，则克隆镜像的缩小操作不再透明，因为在某些情况下（例如，如果克隆镜像有快照或克隆镜像被缩小到不与对象大小对齐的大小），它涉及从父快照复制一些数据，类似于扁平化。如果在执行缩小操作之前没有加载加密，则克隆镜像中之前可访问的任何父数据可能变得不可读。</p>
<p>当通过 rbd-nbd 挂载 RBD 镜像作为块设备时，可以自动应用加密加载。</p>
<h4 id="支持的格式"><a href="#支持的格式" class="headerlink" title="支持的格式"></a>支持的格式</h4><p><strong>LUKS</strong><br>支持 LUKS1 和 LUKS2。数据布局完全符合 LUKS 规范。因此，RBD 格式化的镜像可以使用外部 LUKS 支持工具（如 dm-crypt 或 QEMU）加载。此外，现有的 LUKS 数据（在 RBD 之外创建的）可以导入（通过将原始 LUKS 数据复制到镜像中）并由 RBD 加密加载。</p>
<p>LUKS 格式仅在基于 Linux 的系统上受支持。 当前，仅支持 AES-128 和 AES-256 加密算法。此外，xts-plain64 目前是唯一支持的加密模式。</p>
<p>要使用 LUKS 格式，请首先格式化镜像：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rbd encryption format [--cipher-alg &#123;aes-128|aes-256&#125;] &#123;image-spec&#125; &#123;luks1|luks2&#125; &#123;passphrase-file&#125;</span><br></pre></td></tr></table></figure>
<p>加密格式操作会生成一个 LUKS 头并将其写入镜像的开头。头部附加了一个密钥槽，其中包含一个随机生成的加密密钥，并由从 passphrase-file 读取的密码短语保护。</p>
<p>在较早版本中，如果 passphrase-file 的内容以换行符结束，则会被去除。</p>
<p>默认情况下，将使用 AES-256 的 xts-plain64 模式（这是当前推荐的模式，也是其他工具的通常默认模式）。格式化操作也允许选择 AES-128。目前，RBD 不支持添加&#x2F;移除密码短语，但可以使用兼容工具（如 cryptsetup）应用于原始 RBD 数据。</p>
<p>LUKS 头的大小可能会有所不同（在 LUKS2 中最大为 136MiB），但通常为 16MiB，具体取决于安装的 libcryptsetup 版本。为了优化性能，加密格式会将数据偏移量设置为与镜像条带周期大小对齐。例如，如果使用配置为 8MiB 对象大小的镜像，则期望最小开销为 8MiB；如果使用配置为 4MiB 对象大小且条带计数为 3 的镜像，则期望最小开销为 12MiB。</p>
<p>在 LUKS1 中，扇区是最小的加密单位，固定为 512 字节。LUKS2 支持更大的扇区，为了获得更好的性能，我们将默认扇区大小设置为最大 4KiB。写入小于扇区的内容或不对齐的写入将触发客户端的受保护读写链，并带来相当大的延迟。这样的未对齐写入的批次可能导致 IO 竞争，进一步恶化性能。因此，建议在无法保证传入写入与扇区对齐的情况下，避免使用 RBD 加密。</p>
<p>要映射一个 LUKS 格式化的镜像，请运行：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rbd device map -t nbd -o encryption-passphrase-file=&#123;passphrase-file&#125; &#123;image-spec&#125;</span><br></pre></td></tr></table></figure>

<p>请注意，出于安全原因，加密格式和加密加载操作都是 CPU 密集型的，可能需要几秒钟才能完成。对于实际镜像 IO 的加密操作，假设启用了 AES-NI，相对较小的微秒延迟应被添加，以及少量的 CPU 利用率增加。</p>
<h4 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h4><p>创建一个 LUKS2 格式化的镜像，实际大小为 50GiB：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">rbd create --size 50G mypool/myimage</span><br><span class="line">rbd encryption format mypool/myimage luks2 passphrase.bin</span><br><span class="line">rbd resize --size 50G --encryption-passphrase-file passphrase.bin mypool/myimage</span><br></pre></td></tr></table></figure>

<p><code>rbd resize</code> 命令的最后一步将镜像扩展以补偿与 LUKS2 头相关的开销。</p>
<p>给定一个 LUKS2 格式化的镜像，创建一个具有相同有效大小的 LUKS2 格式化克隆：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">rbd snap create mypool/myimage@snap</span><br><span class="line">rbd snap protect mypool/myimage@snap</span><br><span class="line">rbd clone mypool/myimage@snap mypool/myclone</span><br><span class="line">rbd encryption format mypool/myclone luks2 clone-passphrase.bin</span><br></pre></td></tr></table></figure>

<p>给定一个 LUKS2 格式化的镜像，实际大小为 50GiB，创建一个具有相同有效大小的 LUKS1 格式化克隆：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">rbd snap create mypool/myimage@snap</span><br><span class="line">rbd snap protect mypool/myimage@snap</span><br><span class="line">rbd clone mypool/myimage@snap mypool/myclone</span><br><span class="line">rbd encryption format mypool/myclone luks1 clone-passphrase.bin</span><br><span class="line">rbd resize --size 50G --allow-shrink --encryption-passphrase-file clone-passphrase.bin --encryption-passphrase-file passphrase.bin mypool</span><br><span class="line"></span><br><span class="line">/myclone</span><br></pre></td></tr></table></figure>

<p>由于 LUKS1 头通常小于 LUKS2 头，<code>rbd resize</code> 命令的最后一步将克隆镜像缩小，以去除不需要的空间分配。</p>
<p>给定一个 LUKS1 格式化的镜像，实际大小为 50GiB，创建一个具有相同有效大小的 LUKS2 格式化克隆：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">rbd resize --size 51G mypool/myimage</span><br><span class="line">rbd snap create mypool/myimage@snap</span><br><span class="line">rbd snap protect mypool/myimage@snap</span><br><span class="line">rbd clone mypool/myimage@snap mypool/myclone</span><br><span class="line">rbd encryption format mypool/myclone luks2 clone-passphrase.bin</span><br><span class="line">rbd resize --size 50G --allow-shrink --encryption-passphrase-file passphrase.bin mypool/myimage</span><br><span class="line">rbd resize --size 50G --allow-shrink --encryption-passphrase-file clone-passphrase.bin --encryption-passphrase-file passphrase.bin mypool/myclone</span><br></pre></td></tr></table></figure>

<p>由于 LUKS2 头通常大于 LUKS1 头，<code>rbd resize</code> 命令的开始步骤会暂时扩展父镜像，以保留一些额外的空间在父快照中，从而使克隆镜像中的所有父数据可访问。<code>rbd resize</code> 命令的最后一步将父镜像缩小回其原始大小（这不会影响父快照），并将克隆镜像缩小，以去除未使用的保留空间。</p>
<p>这同样适用于创建格式化克隆未格式化（明文）镜像，因为未格式化镜像完全没有头。</p>
<p>要映射一个格式化的克隆，请为克隆本身和所有显式格式化的父镜像提供加密格式和密码短语。加密格式和密码短语文件选项的顺序应基于镜像层次结构：从克隆镜像开始，然后是其父镜像，依此类推。</p>
<p>以下是映射格式化克隆的命令示例：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rbd device map -t nbd -o encryption-passphrase-file=clone-passphrase.bin,encryption-passphrase-file=passphrase.bin mypool/myclone</span><br></pre></td></tr></table></figure>


<h2 id="RBD-配置设置"><a href="#RBD-配置设置" class="headerlink" title="RBD 配置设置"></a>RBD 配置设置</h2><h4 id="通用设置"><a href="#通用设置" class="headerlink" title="通用设置"></a>通用设置</h4><p><strong>1.rbd_compression_hint</strong><br>写操作时发送给 OSD 的提示。如果设置为 <code>compressible</code> 并且 OSD 的 <code>bluestore_compression_mode</code> 设置为 <code>passive</code>，则 OSD 会尝试压缩数据。如果设置为 <code>incompressible</code> 并且 OSD 的压缩设置为 <code>aggressive</code>，则 OSD 不会尝试压缩数据。</p>
<ul>
<li>类型：字符串 (str)</li>
<li>默认值：none</li>
<li>可选值：<ul>
<li>none</li>
<li>compressible</li>
<li>incompressible</li>
</ul>
</li>
</ul>
<p><strong>2.rbd_read_from_replica_policy</strong><br>确定哪个 OSD 接收读取操作的策略。如果设置为 <code>default</code>，每个 PG 的主 OSD 将始终用于读取操作。如果设置为 <code>balance</code>，读取操作将发送到副本集中的随机选择的 OSD。如果设置为 <code>localize</code>，读取操作将发送到由 CRUSH 图确定的最接近的 OSD。与 <code>rbd_balance_snap_reads</code> 和 <code>rbd_localize_snap_reads</code> 或 <code>rbd_balance_parent_reads</code> 和 <code>rbd_localize_parent_reads</code> 不同，它影响所有读取操作，而不仅仅是快照或父镜像。注意：此功能需要集群配置为最低兼容 OSD 版本 Octopus。</p>
<ul>
<li>类型：字符串 (str)</li>
<li>默认值：default</li>
<li>可选值：<ul>
<li>default</li>
<li>balance</li>
<li>localize</li>
</ul>
</li>
</ul>
<p><strong>3.rbd_default_order</strong><br>配置新镜像的默认对象大小。值作为二的幂使用，意味着 <code>default_object_size = 2 ^ rbd_default_order</code>。配置一个介于 12 和 25 之间的值（包含 12 和 25），对应于 4KiB 下限和 32MiB 上限。</p>
<ul>
<li>类型：无符号整数 (uint)</li>
<li>默认值：22</li>
</ul>
<h4 id="缓存设置"><a href="#缓存设置" class="headerlink" title="缓存设置"></a>缓存设置</h4><p><strong>1.内核缓存</strong><br>Ceph 块设备的内核驱动程序可以使用 Linux 页面缓存来提高性能。</p>
<p>Ceph 块设备的用户空间实现（即 librbd）无法利用 Linux 页面缓存，因此它包含自己的内存缓存，称为“RBD 缓存”。RBD 缓存的行为类似于良好工作的硬盘缓存。当操作系统发送障碍或刷新请求时，所有脏数据会被写入 OSD。这意味着使用回写缓存的安全性与使用良好工作的物理硬盘一样（即 Linux 内核 &gt;&#x3D; 2.6.32）。缓存使用最少最近使用（LRU）算法，在回写模式下，它可以合并连续请求以提高吞吐量。</p>
<p>librbd 缓存默认启用，支持三种不同的缓存策略：写绕过、回写和写直达。在写绕过和回写策略下，写入会立即返回，除非有超过 <code>rbd_cache_max_dirty</code> 的未写入字节到存储集群。写绕过策略与回写策略的不同之处在于它不会尝试从缓存中服务读取请求，因此对于高性能写工作负载更快。在写直达策略下，写入仅在数据在所有副本上都存在时返回，但读取可能来自缓存。</p>
<p>在收到刷新请求之前，缓存表现为写直达缓存，以确保旧操作系统（不会发送刷新以确保崩溃一致性行为）安全操作。</p>
<p>如果禁用 librbd 缓存，写入和读取会直接到达存储集群，写入仅在数据在所有副本上都存在时返回。</p>
<p>缓存位于客户端的内存中，每个 RBD 镜像都有自己的缓存。由于缓存是客户端本地的，如果有其他人访问镜像，缓存之间不会保持一致。运行 GFS 或 OCFS 在 RBD 上时，启用缓存将无法正常工作。</p>
<p>RBD 的选项设置应在配置文件或中央配置存储的 [client] 部分中设置。这些设置包括：</p>
<p><strong>2.rbd_cache</strong><br>启用 RADOS 块设备（RBD）的缓存。</p>
<ul>
<li>类型：布尔值 (bool)</li>
<li>默认值：true</li>
</ul>
<p><strong>3.rbd_cache_policy</strong><br>选择 librbd 的缓存策略。</p>
<ul>
<li>类型：字符串 (str)</li>
<li>默认值：writearound</li>
<li>可选值：<ul>
<li>writethrough</li>
<li>writeback</li>
<li>writearound</li>
</ul>
</li>
</ul>
<p><strong>4.rbd_cache_writethrough_until_flush</strong><br>开始时使用写直达模式，并在收到第一个刷新请求后切换到回写模式。启用此选项是一种保守但安全的策略，适用于运行在 RBD 卷上的虚拟机（如 Linux 内核版本低于 2.6.32 的 virtio 驱动程序）不能发送刷新请求的情况。</p>
<ul>
<li>类型：布尔值 (bool)</li>
<li>默认值：true</li>
</ul>
<p><strong>5.rbd_cache_size</strong><br>每卷 RBD 客户端缓存的大小（以字节为单位）。</p>
<ul>
<li>类型：大小 (size)</li>
<li>默认值：32Mi</li>
<li>策略：回写和写直达</li>
</ul>
<p><strong>6.rbd_cache_max_dirty</strong><br>缓存触发回写的脏数据限制（以字节为单位）。如果为 0，则使用写直达缓存。</p>
<ul>
<li>类型：大小 (size)</li>
<li>默认值：24Mi</li>
<li>约束：必须小于 <code>rbd_cache_size</code></li>
<li>策略：写绕过和回写</li>
</ul>
<p><strong>7.rbd_cache_target_dirty</strong><br>缓存开始将数据写入数据存储之前的脏数据目标值。不会阻止写入缓存。</p>
<ul>
<li>类型：大小 (size)</li>
<li>默认值：16Mi</li>
<li>约束：必须小于 <code>rbd_cache_max_dirty</code></li>
<li>策略：回写</li>
</ul>
<p><strong>8.rbd_cache_max_dirty_age</strong><br>脏数据在缓存中存在的秒数，然后开始回写。</p>
<ul>
<li>类型：浮点数 (float)</li>
<li>默认值：1.0</li>
<li>策略：回写</li>
</ul>
<h4 id="预读设置"><a href="#预读设置" class="headerlink" title="预读设置"></a>预读设置</h4><p>librbd 支持预读&#x2F;预取，以优化小的、顺序的读取。这通常应该由虚拟机的操作系统处理，但引导加载程序可能不会发出有效的读取。如果缓存被禁用或策略为写绕过，则预读会自动禁用。<br><strong>1.rbd_readahead_trigger_requests</strong><br>触发预读所需的顺序请求数量。</p>
<ul>
<li>类型：无符号整数 (uint)</li>
<li>默认值：10</li>
</ul>
<p><strong>2.rbd_readahead_max_bytes</strong><br>预读请求的最大大小。如果为零，则禁用预读。</p>
<ul>
<li>类型：大小 (size)</li>
<li>默认值：512Ki</li>
</ul>
<p><strong>3.rbd_readahead_disable_after_bytes</strong><br>从 RBD 镜像中读取此字节数后，预读对该镜像将被禁用，直到它关闭。这允许来宾操作系统在启动后接管预读。如果为零，则预读保持启用。</p>
<ul>
<li>类型：大小 (size)</li>
<li>默认值：50Mi</li>
</ul>
<h4 id="镜像特性"><a href="#镜像特性" class="headerlink" title="镜像特性"></a>镜像特性</h4><p>RBD 支持通过命令行创建镜像时指定高级功能，或通过 <code>rbd_default_features = &lt;特性数值总和&gt;</code> 或 <code>rbd_default_features = &lt;逗号分隔的 CLI 值列表&gt;</code> 配置默认特性。</p>
<p><strong>layering</strong><br>描述<br>层叠启用克隆。</p>
<ul>
<li>内部值：1</li>
<li>CLI 值：layering</li>
<li>添加于：v0.52 (Bobtail)</li>
<li>KRBD 支持：从 v3.10 起</li>
<li>默认值：是</li>
</ul>
<p><strong>striping v2</strong><br>描述<br>条带将数据分散到多个对象上。条带有助于顺序读&#x2F;写工作负载的并行性。</p>
<ul>
<li>内部值：2</li>
<li>CLI 值：striping</li>
<li>添加于：v0.55 (Bobtail)</li>
<li>KRBD 支持：从 v3.10 起（仅默认条带，v4.17 添加了“Fancy”条带）</li>
<li>默认值：是</li>
</ul>
<p><strong>exclusive-lock</strong><br>描述<br>启用时，要求客户端在进行写入之前对对象进行锁定。排他锁应仅在任何时候只有一个客户端访问镜像时启用。</p>
<ul>
<li>内部值：4</li>
<li>CLI 值：exclusive-lock</li>
<li>添加于：v0.92 (Hammer)</li>
<li>KRBD 支持：从 v4.9 起</li>
<li>默认值：是</li>
</ul>
<p><strong>object-map</strong><br>描述<br>对象映射支持依赖于排他锁支持。块设备是瘦配置的，这意味着它们仅存储实际写入的数据，即它们是稀疏的。对象映射支持有助于跟踪哪些对象实际存在（在设备上存储有数据）。启用对象映射支持可以加快克隆、导入和导出稀疏填充镜像以及删除的 I&#x2F;O 操作。</p>
<ul>
<li>内部值：8</li>
<li>CLI 值：object-map</li>
<li>添加于：v0.93 (Hammer)</li>
<li>KRBD 支持：从 v5.3 起</li>
<li>默认值：是</li>
</ul>
<p><strong>fast-diff</strong><br>描述<br>快速差异支持依赖于对象映射支持和排他锁支持。它为对象映射添加了另一个属性，使生成镜像快照之间的差异变得更快。它还更快地计算快照或卷的实际数据使用量（<code>rbd du</code>）。</p>
<ul>
<li>内部值：16</li>
<li>CLI 值：fast-diff</li>
<li>添加于：v9.0.1 (Infernalis)</li>
<li>KRBD 支持：从 v5.3 起</li>
<li>默认值：是</li>
</ul>
<p><strong>deep-flatten</strong><br>描述<br>深度扁平化使 <code>rbd flatten</code> 能在镜像的所有快照上工作，除了镜像本身。没有它，镜像的快照仍将依赖于父镜像，因此在删除父镜像之前必须先删除快照。深度扁平化使父镜像独立于其克隆，即使它们有快照，也不会受到影响，但会使用额外的 OSD 设备空间。</p>
<ul>
<li>内部值：32</li>
<li>CLI 值：deep-flatten</li>
<li>添加于：v9.0.2 (Infernalis)</li>
<li>KRBD 支持：从 v5.1 起</li>
<li>默认值：是</li>
</ul>
<p><strong>journaling</strong><br>描述<br>日志记录支持依赖于排他锁支持。日志记录按发生顺序记录对镜像的所有修改。RBD 镜像可以利用日志记录将崩溃一致的镜像复制到远程集群。最好让 <code>rbd-mirror</code> 仅在需要时管理此功能，因为长期启用可能导致大量额外的 OSD 空间消耗。</p>
<ul>
<li>内部值：64</li>
<li>CLI 值：journaling</li>
<li>添加于：v10.0.1 (Jewel)</li>
<li>KRBD 支持：无</li>
<li>默认值：否</li>
</ul>
<p><strong>Data pool</strong><br>描述<br>在纠删码池上，镜像数据块对象需要存储在与镜像元数据不同的池中。</p>
<ul>
<li>内部值：128</li>
<li>添加于：v11.1.0 (Kraken)</li>
<li>KRBD 支持：从 v4.11 起</li>
<li>默认值：否</li>
</ul>
<p><strong>Operations</strong><br>描述<br>用于限制旧客户端对镜像执行某些维护操作（例如克隆、创建快照）。</p>
<ul>
<li>内部值：256</li>
<li>添加于：v13.0.2 (Mimic)</li>
<li>KRBD 支持：从 v4.16 起</li>
</ul>
<p><strong>Migrating</strong><br>描述<br>用于限制旧客户端在镜像处于迁移状态时打开镜像。</p>
<ul>
<li>内部值：512</li>
<li>添加于：v14.0.1 (Nautilus)</li>
<li>KRBD 支持：无</li>
</ul>
<p><strong>Non-primary</strong><br>描述<br>用于限制使用基于快照的镜像镜像的非主副本进行更改。</p>
<ul>
<li>内部值：1024</li>
<li>添加于：v15.2.0 (Octopus)</li>
<li>KRBD 支持：无</li>
</ul>
<h4 id="QOS-设置"><a href="#QOS-设置" class="headerlink" title="QOS 设置"></a>QOS 设置</h4><p>librbd 支持以几种方式限制每个镜像的 I&#x2F;O。这些限制适用于给定进程中的给定镜像——例如，在多个地方使用的同一镜像（例如两个独立的虚拟机）会有独立的限制。</p>
<ul>
<li>IOPS：每秒 I&#x2F;O 操作数（任何类型的 I&#x2F;O）</li>
<li>读取 IOPS：每秒读取 I&#x2F;O 操作数</li>
<li>写入 IOPS：每秒写入 I&#x2F;O 操作数</li>
<li>bps：每秒字节数（任何类型的 I&#x2F;O）</li>
<li>读取 bps：每秒读取字节数</li>
<li>写入 bps：每秒写入字节数</li>
</ul>
<p>这些限制彼此独立操作。默认情况下，它们都处于关闭状态。每种限制类型使用令牌桶算法来限制 I&#x2F;O，能够配置限制（时间上的平均速度）和较高的速率（突发）在短时间内（<code>burst_seconds</code>）。当达到这些限制并且没有剩余的突发容量时，librbd 会将该类型 I&#x2F;O 的速率降低到限制值。</p>
<p>例如，如果配置了 100MB 的读取 bps 限制，但写入没有限制，则写入可以尽可能快地进行，而读取将被限制为 100MB&#x2F;s。如果设置了 150MB 的读取突发和 5 秒的读取突发时间，则读取可以以 150MB&#x2F;s 的速度进行长达 5 秒，然后恢复到 100MB&#x2F;s 的限制。</p>
<p>以下选项配置这些限制：</p>
<h5 id="rbd-qos-iops-limit"><a href="#rbd-qos-iops-limit" class="headerlink" title="rbd_qos_iops_limit"></a>rbd_qos_iops_limit</h5><p>每秒 I&#x2F;O 操作数的期望限制。</p>
<ul>
<li>类型：无符号整数 (uint)</li>
<li>默认值：0</li>
</ul>
<h5 id="rbd-qos-iops-burst"><a href="#rbd-qos-iops-burst" class="headerlink" title="rbd_qos_iops_burst"></a>rbd_qos_iops_burst</h5><p>I&#x2F;O 操作的期望突发限制。</p>
<ul>
<li>类型：无符号整数 (uint)</li>
<li>默认值：0</li>
</ul>
<h5 id="rbd-qos-iops-burst-seconds"><a href="#rbd-qos-iops-burst-seconds" class="headerlink" title="rbd_qos_iops_burst_seconds"></a>rbd_qos_iops_burst_seconds</h5><p>I&#x2F;O 操作的期望突发持续时间（以秒为单位）。</p>
<ul>
<li>类型：无符号整数 (uint)</li>
<li>默认值：1</li>
<li>最小值：1</li>
</ul>
<h5 id="rbd-qos-read-iops-limit"><a href="#rbd-qos-read-iops-limit" class="headerlink" title="rbd_qos_read_iops_limit"></a>rbd_qos_read_iops_limit</h5><p>每秒读取操作数的期望限制。</p>
<ul>
<li>类型：无符号整数 (uint)</li>
<li>默认值：0</li>
</ul>
<h5 id="rbd-qos-read-iops-burst"><a href="#rbd-qos-read-iops-burst" class="headerlink" title="rbd_qos_read_iops_burst"></a>rbd_qos_read_iops_burst</h5><p>读取操作的期望突发限制。</p>
<ul>
<li>类型：无符号整数 (uint)</li>
<li>默认值：0</li>
</ul>
<h5 id="rbd-qos-read-iops-burst-seconds"><a href="#rbd-qos-read-iops-burst-seconds" class="headerlink" title="rbd_qos_read_iops_burst_seconds"></a>rbd_qos_read_iops_burst_seconds</h5><p>读取操作的期望突发持续时间（以秒为单位）。</p>
<ul>
<li>类型：无符号整数 (uint)</li>
<li>默认值：1</li>
<li>最小值：1</li>
</ul>
<h5 id="rbd-qos-write-iops-limit"><a href="#rbd-qos-write-iops-limit" class="headerlink" title="rbd_qos_write_iops_limit"></a>rbd_qos_write_iops_limit</h5><p>每秒写入操作数的期望限制。</p>
<ul>
<li>类型：无符号整数 (uint)</li>
<li>默认值：0</li>
</ul>
<h5 id="rbd-qos-write-iops-burst"><a href="#rbd-qos-write-iops-burst" class="headerlink" title="rbd_qos_write_iops_burst"></a>rbd_qos_write_iops_burst</h5><p>写入操作的期望突发限制。</p>
<ul>
<li>类型：无符号整数 (uint)</li>
<li>默认值：0</li>
</ul>
<h5 id="rbd-qos-write-iops-burst-seconds"><a href="#rbd-qos-write-iops-burst-seconds" class="headerlink" title="rbd_qos_write_iops_burst_seconds"></a>rbd_qos_write_iops_burst_seconds</h5><p>写入操作的期望突发持续时间（以秒为单位）。</p>
<ul>
<li>类型：无符号整数 (uint)</li>
<li>默认值：1</li>
<li>最小值：1</li>
</ul>
<h5 id="rbd-qos-bps-limit"><a href="#rbd-qos-bps-limit" class="headerlink" title="rbd_qos_bps_limit"></a>rbd_qos_bps_limit</h5><p>每秒 I&#x2F;O 字节数的期望限制。</p>
<ul>
<li>类型：无符号整数 (uint)</li>
<li>默认值：0</li>
</ul>
<h5 id="rbd-qos-bps-burst"><a href="#rbd-qos-bps-burst" class="headerlink" title="rbd_qos_bps_burst"></a>rbd_qos_bps_burst</h5><p>I&#x2F;O 字节的期望突发限制。</p>
<ul>
<li>类型：无符号整数 (uint)</li>
<li>默认值：0</li>
</ul>
<h5 id="rbd-qos-bps-burst-seconds"><a href="#rbd-qos-bps-burst-seconds" class="headerlink" title="rbd_qos_bps_burst_seconds"></a>rbd_qos_bps_burst_seconds</h5><p>I&#x2F;O 字节的期望突发持续时间（以秒为单位）。</p>
<ul>
<li>类型：无符号整数 (uint)</li>
<li>默认值：1</li>
<li>最小值：1</li>
</ul>
<h5 id="rbd-qos-read-bps-limit"><a href="#rbd-qos-read-bps-limit" class="headerlink" title="rbd_qos_read_bps_limit"></a>rbd_qos_read_bps_limit</h5><p>每秒读取字节数的期望限制。</p>
<ul>
<li>类型：无符号整数 (uint)</li>
<li>默认值：0</li>
</ul>
<h5 id="rbd-qos-read-bps-burst"><a href="#rbd-qos-read-bps-burst" class="headerlink" title="rbd_qos_read_bps_burst"></a>rbd_qos_read_bps_burst</h5><p>读取字节的期望突发限制。</p>
<ul>
<li>类型：无符号整数 (uint)</li>
<li>默认值：0</li>
</ul>
<h5 id="rbd-qos-read-bps-burst-seconds"><a href="#rbd-qos-read-bps-burst-seconds" class="headerlink" title="rbd_qos_read_bps_burst_seconds"></a>rbd_qos_read_bps_burst_seconds</h5><p>读取字节的期望突发持续时间（以秒为单位）。</p>
<ul>
<li>类型：无符号整数 (uint)</li>
<li>默认值：1</li>
<li>最小值：1</li>
</ul>
<h5 id="rbd-qos-write-bps-limit"><a href="#rbd-qos-write-bps-limit" class="headerlink" title="rbd_qos_write_bps_limit"></a>rbd_qos_write_bps_limit</h5><p>每秒写入字节数的期望限制。</p>
<ul>
<li>类型：无符号整数 (uint)</li>
<li>默认值：0</li>
</ul>
<h5 id="rbd-qos-write-bps-burst"><a href="#rbd-qos-write-bps-burst" class="headerlink" title="rbd_qos_write_bps_burst"></a>rbd_qos_write_bps_burst</h5><p>写入字节的期望突发限制。</p>
<ul>
<li>类型：无符号整数 (uint)</li>
<li>默认值：0</li>
</ul>
<h5 id="rbd-qos-write-bps-burst-seconds"><a href="#rbd-qos-write-bps-burst-seconds" class="headerlink" title="rbd_qos_write_bps_burst_seconds"></a>rbd_qos_write_bps_burst_seconds</h5><p>写入字节的期望突发持续时间（以秒为单位）。</p>
<ul>
<li>类型：无符号整数 (uint)</li>
<li>默认值：1</li>
<li>最小值：1</li>
</ul>
<h5 id="rbd-qos-schedule-tick-min"><a href="#rbd-qos-schedule-tick-min" class="headerlink" title="rbd_qos_schedule_tick_min"></a>rbd_qos_schedule_tick_min</h5><p>此设置决定了 I&#x2F;O 在限制被触发时可以解锁的最小时间（以毫秒为单位）。就令牌桶算法而言，这是添加令牌到桶中的最小间隔。</p>
<ul>
<li>类型：无符号整数 (uint)</li>
<li>默认值：50</li>
<li>最小值：1</li>
</ul>
<h5 id="rbd-qos-exclude-ops"><a href="#rbd-qos-exclude-ops" class="headerlink" title="rbd_qos_exclude_ops"></a>rbd_qos_exclude_ops</h5><p>可选地从 QoS 排除操作。此设置接受整数位掩码值或逗号分隔的操作名称字符串。此设置始终作为整数位掩码值内部存储。操作位掩码值与操作名称的映射如下：+1 -&gt; 读取，+2 -&gt; 写入，+4 -&gt; 丢弃，+8 -&gt; write_same，+16 -&gt; compare_and_write</p>
<ul>
<li>类型：字符串 (str)</li>
</ul>
<h2 id="RBD-重放"><a href="#RBD-重放" class="headerlink" title="RBD 重放"></a>RBD 重放</h2><p>RBD 重放是一组用于捕获和重放 RADOS 块设备（RBD）工作负载的工具。要捕获 RBD 工作负载，客户端必须安装 lttng-tools，并且客户端上的 librbd 必须是 v0.87（Giant）版本或更高版本。要重放 RBD 工作负载，客户端上的 librbd 必须是 Giant 版本或更高版本。<br>捕获和重放的步骤如下：</p>
<ol>
<li><p><strong>捕获跟踪数据</strong>。确保捕获 pthread_id 上下文：</p>
 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p traces</span><br><span class="line">lttng create -o traces librbd</span><br><span class="line">lttng enable-event -u <span class="string">&#x27;librbd:*&#x27;</span></span><br><span class="line">lttng add-context -u -t pthread_id</span><br><span class="line">lttng start</span><br><span class="line"><span class="comment"># 在这里运行 RBD 工作负载</span></span><br><span class="line">lttng stop</span><br></pre></td></tr></table></figure></li>
<li><p><strong>处理跟踪数据</strong>，使用 <code>rbd-replay-prep</code>：</p>
 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rbd-replay-prep traces/ust/uid/*/* replay.bin</span><br></pre></td></tr></table></figure></li>
<li><p><strong>重放跟踪数据</strong>，使用 <code>rbd-replay</code>。在确认它做了你想要的操作之前，使用只读模式：</p>
 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rbd-replay --read-only replay.bin</span><br></pre></td></tr></table></figure></li>
</ol>
<p><strong>重要提示</strong></p>
<ul>
<li><code>rbd-replay</code> 默认情况下会销毁数据。除非使用 <code>--read-only</code> 选项，否则不要对希望保留的镜像使用。</li>
<li>重放的工作负载不必与捕获的工作负载使用相同的 RBD 镜像或相同的集群。为了处理差异，可能需要使用 <code>--pool</code> 和 <code>--map-image</code> 选项。</li>
</ul>

      
    </div>
    <div class="article-footer">
      <blockquote class="mt-2x">
  <ul class="post-copyright list-unstyled">
    
    <li class="post-copyright-link hidden-xs">
      <strong>本文链接：</strong>
      <a href="https://watsonlu6.github.io/Storage/Ceph/Ceph-rbd%E4%BB%8B%E7%BB%8D%E4%B8%8E%E4%BD%BF%E7%94%A8/" title="Ceph_rbd介绍与使用" target="_blank" rel="external">https://watsonlu6.github.io/Storage/Ceph/Ceph-rbd介绍与使用/</a>
    </li>
    
    <li class="post-copyright-license">
      <strong>版权声明： </strong> 本博客所有文章除特别声明外，均采用 <a href="http://creativecommons.org/licenses/by/4.0/deed.zh" target="_blank" rel="external">CC BY 4.0 CN协议</a> 许可协议。转载请注明出处！
    </li>
  </ul>
</blockquote>


<div class="panel panel-default panel-badger">
  <div class="panel-body">
    <figure class="media">
      <div class="media-left">
        <a href="https://github.com/watsonLu6/" target="_blank" class="img-burn thumb-sm visible-lg">
          <img src="/images/avatar.jpg" class="img-rounded w-full" alt="">
        </a>
      </div>
      <div class="media-body">
        <h3 class="media-heading"><a href="https://github.com/watsonLu6/" target="_blank"><span class="text-dark">watson</span><small class="ml-1x">Cloud computing development engineer</small></a></h3>
        <div>内心要狂热，头脑要冷静，四肢要发达</div>
      </div>
    </figure>
  </div>
</div>


    </div>
  </article>
  
    
  <section id="comments">
  	
      <div id="vcomments"></div>
    
  </section>


  
</div>

  <nav class="bar bar-footer clearfix" data-stick-bottom>
  <div class="bar-inner">
  
  <ul class="pager pull-left">
    
    <li class="prev">
      <a href="/Storage/Ceph/Ceph-rbd%E6%BA%90%E7%A0%81%E5%AE%9E%E7%8E%B0/" title="Ceph_rbd客户端实现"><i class="icon icon-angle-left" aria-hidden="true"></i><span>&nbsp;&nbsp;上一篇</span></a>
    </li>
    
    
    <li class="next">
      <a href="/Storage/Ceph/Ceph-crush%E7%AE%97%E6%B3%95%E5%AE%9E%E7%8E%B0/" title="Ceph_crush算法实现"><span>下一篇&nbsp;&nbsp;</span><i class="icon icon-angle-right" aria-hidden="true"></i></a>
    </li>
    
    
  </ul>
  
  
  
  <div class="bar-right">
    
    <div class="share-component" data-sites="weibo,qq,wechat,facebook,twitter" data-mobile-sites="weibo,qq,qzone"></div>
    
  </div>
  </div>
</nav>
  


</main>

  <footer class="footer" itemscope itemtype="http://schema.org/WPFooter">
	
	
    <ul class="social-links">
    	
        <li><a href="https://github.com/watsonLu6/" target="_blank" title="Github" data-toggle=tooltip data-placement=top><i class="icon icon-github"></i></a></li>
        
        <li><a href="http://weibo.com" target="_blank" title="Weibo" data-toggle=tooltip data-placement=top><i class="icon icon-weibo"></i></a></li>
        
        <li><a href="https://twitter.com" target="_blank" title="Twitter" data-toggle=tooltip data-placement=top><i class="icon icon-twitter"></i></a></li>
        
        <li><a href="https://www.behance.net" target="_blank" title="Behance" data-toggle=tooltip data-placement=top><i class="icon icon-behance"></i></a></li>
        
        <li><a href="/atom.xml" target="_blank" title="Rss" data-toggle=tooltip data-placement=top><i class="icon icon-rss"></i></a></li>
        
    </ul>

    <div class="copyright">
    	
        <div class="publishby">
        	Theme by <a href="https://github.com/cofess" target="_blank"> cofess </a>base on <a href="https://github.com/cofess/hexo-theme-pure" target="_blank">pure</a>.
        </div>
    </div>
</footer>
  <script src="//cdn.jsdelivr.net/npm/jquery@1.12.4/dist/jquery.min.js"></script>
<script>
window.jQuery || document.write('<script src="js/jquery.min.js"><\/script>')
</script>

<script src="/js/plugin.min.js"></script>


<script src="/js/application.js"></script>


    <script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: '文章',
            PAGES: '页面',
            CATEGORIES: '分类',
            TAGS: '标签',
            UNTITLED: '(未命名)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>

<script src="/js/insight.js"></script>






   




   
    
  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/valine"></script>
  <script type="text/javascript">
  var GUEST = ['nick', 'mail', 'link'];
  var meta = 'nick,mail,link';
  meta = meta.split(',').filter(function(item) {
    return GUEST.indexOf(item) > -1;
  });
  new Valine({
    el: '#vcomments',
    verify: false,
    notify: false,
    appId: '',
    appKey: '',
    placeholder: 'Just go go',
    avatar: 'mm',
    meta: meta,
    pageSize: '10' || 10,
    visitor: false
  });
  </script>

     







</body>
</html>